<!DOCTYPE html>






<head>
  
</head>


<html>
<style>
	
	
body{
  margin: 10px;	
}
.version{
	text-align: right;
	padding: 3px;
	font-size: 10px;
}
.grid-container-header {
  display: grid;
  grid-template-columns: 200px 100px 100px 100px 100px 100px 100px 100px 100px;
  width: 1000px;
  background-color: #2196F3;
  padding: 0px;
}
.grid-bright {
  display: grid;
  grid-template-columns: 300px 100px 100px 100px 100px 100px 100px 100px;
  width: 1000px;
  background-color: #ebf3fb;
  padding: 0px;
}
.grid-dark {
  display: grid;
  grid-template-columns: 300px 100px 100px 100px 100px 100px 100px 100px;
  width: 1000px;
  background-color: #c1c1c1;
  padding: 0px;
}
.grid-tot {
  display: grid;
  grid-template-columns: 300px 100px 100px 100px 100px 100px 100px 100px;
  width: 1000px;
  background-color: #79b178;
  padding: 0px;
}
.grid-item {
  background-color: rgba(255, 255, 255, 0.8);
  border: 0px solid rgba(0, 0, 0, 0.8);
  padding: 0px;
  font-size: 20px;
  text-align: center;
}
.grid-item-left {
  background-color: rgba(255, 255, 255, 0.8);
  border: 0px solid rgba(0, 0, 0, 0.8);
  padding: 0px;
  font-size: 20px;
  text-align: right;
}
	
.grid-title-left {
  background-color: rgba(255, 255, 255, 0.8);
  border: 0px solid rgba(0, 0, 0, 0.8);
  padding: 0px;
  font-size: 20px;
  text-align: left;
  color: red;
}
	
.bar-container {
  display: grid;
  grid-template-columns: auto auto auto auto;
  background-color: #2196F3;
  padding: 5px;
}
.bar-item {
  background-color: rgba(255, 255, 255, 0.8);
  border: 0px solid rgba(0, 0, 0, 0.8);
  padding: 0px;
  font-size: 20px;
  text-align: center;
}
.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}
	
/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}   
  
input[type=text], input[type=password] {
    width: 200px;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
button {
    background-color: #f68a1f;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 4px;
    cursor: pointer;
	  border-radius: 4px;
	  -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
	  font-family: "Myriad pro","Trebuchet MS","Lucida Grande","Lucida Sans Unicode","Lucida Sans",sans-serif;
}
button:hover {
    background-color: #da7009;
    color: white;	
}
	
button:disabled,
button[disabled]{
  background-color: #f68a1f;
  opacity: 0.5;
}
	
.cancelbtn {
    width: auto;
    padding: 10px 18px;
    background-color: #f44336;
}
.imgcontainer {
    text-align: center;
    margin: 24px 0 12px 0;
}
img.avatar {
    width: 40%;
    border-radius: 50%;
}
	
.label {
    color: black;
    width: 120px;
    height: 50px;
    padding: 6px;
    display: block;
    float:left;
    vertical-align: middle;
}
	
.loginelement {
    width: 130px;
    height: 50px;
    vertical-align: middle;
    line-height: 50px;
    float: left;
}
.container {
    padding: 16px;
}
span.psw {
    float: right;
    padding-top: 16px;
}
/* Change styles for span and cancel button on extra small screens */
@media screen and (max-width: 300px) {
    span.psw {
       display: block;
       float: none;
    }
    .cancelbtn {
       width: 100%;
    }
}
</style>
<body>
  
  <div id="myloader" style="display:none;">
    	<h2>Loading your page...</h2>
    	<div class="loader"></div>
  </div>
    




  <div id="mylogin" style="display:none;">
    
    <h2>Report Login</h2>
        <div class="loginelement"><b>Account Number</b></div>
	<input id="accnumb" type="text" placeholder="Enter Account Number">
	</br>
	
	<div class="loginelement"><b>Username</b></div>
        <input id="uname" type="text" placeholder="Enter Username">
	</br>
        
	<div class="loginelement"><b>Password</b></div>
        <input id="pwd" type="password" placeholder="Enter Password">
	</br>
        
    <button id="submitLogin" >Login</button>
    
    </br></br></br></br>

  <div id="sendStat"></div>

</div>


<div id="myreports" style="display:none;">
	
    
    </br>
    <div id="version" class="version">v1.1.12</div>
    <button type="button" id ="logout" class="logout" style="float: right;">Log Out</button>

    <div class="bar-container" style="display:none;">
  	<div class="bar-item">open</div>
  	<div class="bar-item">pending</div>
  	<div class="bar-item">unassigned</div>
	<div class="bar-item">limbo</div>
  	<div class="bar-item">overdue</div>
  	<div class="bar-item">soon overdue</div>
  	<div id="open" class="bar-item"></div>  
  	<div id="pending" class="bar-item"></div>
  	<div id="unassigned" class="bar-item"></div>
	<div id="limbo" class="bar-item"></div>
  	<div id="overdue" class="bar-item"></div> 
  	<div id="soonOverdue" class="bar-item"></div>
    </div>

	</br></br>
    
    <div id="reportHeroku"></div>
    <div id="reportBot"></div>



    <div id="loadingStats">
	    </br></br>
	    <label><b>...loading your stats...</b></label></br></br>
	    <div class="loader"></div>
	    </br></br>
	    <div id="loaderMSG"></div>
	    </br>
    </div>
	
    

    <div id="loadedStats" style="display:none;">
	    </br>


<!--
	    <h2>Statistics:</h2>
	<label><b>Skill</b></label></br>   
	<div id="skill"></div>
	<label><b>Team</b></label></br>
 	<div id="team"></div>
	    </br>
	<label><b>Start custom date</b></label></br>
    	<input id="customDate" type="date" />
	<input id="customHour" type="time"></br>
	<label><b>End custom date</b></label></br>
    	<input id="endCustomDate" type="date" />
	<input id="endCustomHour" type="time"></br>
	<div id="refreshMSG"></div>
	
        </br></br>
-->

	<button type="button" id ="refresh" class="refresh" style="float: right;">Refresh</button>

	    
	<div class="grid-container-header">
		<div class="grid-title-left">FaceBook PM</div> 
  		<div class="grid-item-left">skill</div>  
  		<div class="grid-item" id="openConv">open</div>
		<div class="grid-item" id="assignedConv">assigned</div>
  		<div class="grid-item" id="unassignedConv">unassigned</div>
		<div class="grid-item" id="onlineAgents">online</div>
		<div class="grid-item" id="awayAgents">away</div>
		<div class="grid-item" id="backsoonAgents">back soon</div>
		<div class="grid-item" id="maxSlots">slots</div>
	</div>
	<div class="grid-bright">
  		<div class="grid-item-left">Facebook_priv</div>
  		<div class="grid-item" id="FBPopenConv"></div>
		<div class="grid-item" id="FBPassignedConv"></div>
		<div class="grid-item" id="FBPunassignedConv"></div>
		<div class="grid-item" id="FBPonlineAgents"></div>
		<div class="grid-item" id="FBPawayAgents"></div>
		<div class="grid-item" id="FBPsoonAgents"></div>
		<div class="grid-item" id="FBPslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Facebook_risvegliate</div>
  		<div class="grid-item" id="FBRopenConv"></div>
		<div class="grid-item" id="FBRassignedConv"></div>
		<div class="grid-item" id="FBRunassignedConv"></div>
		<div class="grid-item" id="FBRonlineAgents"></div>
		<div class="grid-item" id="FBRawayAgents"></div>
		<div class="grid-item" id="FBRsoonAgents"></div>
		<div class="grid-item" id="FBRslots"></div>
	</div>
	
	<div class="grid-bright">
  		<div class="grid-item-left">Facebook_priv_night</div>
  		<div class="grid-item" id="FBPNopenConv"></div>
		<div class="grid-item" id="FBPNassignedConv"></div>
		<div class="grid-item" id="FBPNunassignedConv"></div>
		<div class="grid-item" id="FBPNonlineAgents"></div>
		<div class="grid-item" id="FBPNawayAgents"></div>
		<div class="grid-item" id="FBPNsoonAgents"></div>
		<div class="grid-item" id="FBPNslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Facebook_priv_night_risvegliate</div>
  		<div class="grid-item" id="FBPNRopenConv"></div>
		<div class="grid-item" id="FBPNRassignedConv"></div>
		<div class="grid-item" id="FBPNRunassignedConv"></div>
		<div class="grid-item" id="FBPNRonlineAgents"></div>
		<div class="grid-item" id="FBPNRawayAgents"></div>
		<div class="grid-item" id="FBPNRsoonAgents"></div>
		<div class="grid-item" id="FBPNRslots"></div>
	</div>
	
	<div class="grid-bright">
  		<div class="grid-item-left">Fixed</div>
  		<div class="grid-item" id="FIXopenConv"></div>
		<div class="grid-item" id="FIXassignedConv"></div>
		<div class="grid-item" id="FIXunassignedConv"></div>
		<div class="grid-item" id="FIXonlineAgents"></div>
		<div class="grid-item" id="FIXawayAgents"></div>
		<div class="grid-item" id="FIXsoonAgents"></div>
		<div class="grid-item" id="FIXslots"></div>
	</div>
	
	<div class="grid-dark">
  		<div class="grid-item-left">Fixed_risvegliate</div>
  		<div class="grid-item" id="FIXRopenConv"></div>
		<div class="grid-item" id="FIXRassignedConv"></div>
		<div class="grid-item" id="FIXRunassignedConv"></div>
		<div class="grid-item" id="FIXRonlineAgents"></div>
		<div class="grid-item" id="FIXRawayAgents"></div>
		<div class="grid-item" id="FIXRsoonAgents"></div>
		<div class="grid-item" id="FIXRslots"></div>
	</div>

	<div class="grid-tot">
  		<div class="grid-item-left">Totale</div>
  		<div class="grid-item" id="TFBopenConv"></div>
		<div class="grid-item" id="TFBassignedConv"></div>
		<div class="grid-item" id="TFBunassignedConv"></div>
		<div class="grid-item" id="TFBonlineAgents"></div>
		<div class="grid-item" id="TFBawayAgents"></div>
		<div class="grid-item" id="TFBsoonAgents"></div>
		<div class="grid-item" id="TFBslots"></div>
	</div></br>

	<div class="grid-container-header">
		<div class="grid-title-left">Chat Web</div> 
  		<div class="grid-item-left">skill</div>  
  		<div class="grid-item" id="openConv">open</div>
		<div class="grid-item" id="assignedConv">assigned</div>
  		<div class="grid-item" id="unassignedConv">unassigned</div>
		<div class="grid-item" id="onlineAgents">online</div>
		<div class="grid-item" id="awayAgents">away</div>
		<div class="grid-item" id="backsoonAgents">back soon</div>
		<div class="grid-item" id="maxSlots">slots</div>
	</div>
	
	<div class="grid-bright">
  		<div class="grid-item-left">Human</div>
  		<div class="grid-item" id="HopenConv"></div>
		<div class="grid-item" id="HassignedConv"></div>
		<div class="grid-item" id="HunassignedConv"></div>
		<div class="grid-item" id="HonlineAgents"></div>
		<div class="grid-item" id="HawayAgents"></div>
		<div class="grid-item" id="HsoonAgents"></div>
		<div class="grid-item" id="Hslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Human_risvegliate</div>
  		<div class="grid-item" id="HRopenConv"></div>
		<div class="grid-item" id="HRassignedConv"></div>
		<div class="grid-item" id="HRunassignedConv"></div>
		<div class="grid-item" id="HRonlineAgents"></div>
		<div class="grid-item" id="HRawayAgents"></div>
		<div class="grid-item" id="HRsoonAgents"></div>
		<div class="grid-item" id="HRslots"></div>
	</div>

	<div class="grid-bright">
  		<div class="grid-item-left">Human_night</div>
  		<div class="grid-item" id="HNopenConv"></div>
		<div class="grid-item" id="HNassignedConv"></div>
		<div class="grid-item" id="HNunassignedConv"></div>
		<div class="grid-item" id="HNonlineAgents"></div>
		<div class="grid-item" id="HNawayAgents"></div>
		<div class="grid-item" id="HNsoonAgents"></div>
		<div class="grid-item" id="HNslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Human_night_risvegliate</div>
  		<div class="grid-item" id="HNRopenConv"></div>
		<div class="grid-item" id="HNRassignedConv"></div>
		<div class="grid-item" id="HNRunassignedConv"></div>
		<div class="grid-item" id="HNRonlineAgents"></div>
		<div class="grid-item" id="HNRawayAgents"></div>
		<div class="grid-item" id="HNRsoonAgents"></div>
		<div class="grid-item" id="HNRslots"></div>
	</div>

	<div class="grid-tot">
  		<div class="grid-item-left">Totale</div>
  		<div class="grid-item" id="TWebopenConv"></div>
		<div class="grid-item" id="TWebassignedConv"></div>
		<div class="grid-item" id="TWebunassignedConv"></div>
		<div class="grid-item" id="TWebonlineAgents"></div>
		<div class="grid-item" id="TWebawayAgents"></div>
		<div class="grid-item" id="TWebsoonAgents"></div>
		<div class="grid-item" id="TWebslots"></div>
	</div></br>

	<div class="grid-container-header">
		<div class="grid-title-left">Outbound</div> 
  		<div class="grid-item-left">skill</div>  
  		<div class="grid-item" id="openConv">open</div>
		<div class="grid-item" id="assignedConv">assigned</div>
  		<div class="grid-item" id="unassignedConv">unassigned</div>
		<div class="grid-item" id="onlineAgents">online</div>
		<div class="grid-item" id="awayAgents">away</div>
		<div class="grid-item" id="backsoonAgents">back soon</div>
		<div class="grid-item" id="maxSlots">slots</div>
	</div>

	<div class="grid-bright">
  		<div class="grid-item-left">Outbound</div>
  		<div class="grid-item" id="OopenConv"></div>
		<div class="grid-item" id="OassignedConv"></div>
		<div class="grid-item" id="OunassignedConv"></div>
		<div class="grid-item" id="OonlineAgents"></div>
		<div class="grid-item" id="OawayAgents"></div>
		<div class="grid-item" id="OsoonAgents"></div>
		<div class="grid-item" id="Oslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Outbound_risvegliate</div>
  		<div class="grid-item" id="ORopenConv"></div>
		<div class="grid-item" id="ORassignedConv"></div>
		<div class="grid-item" id="ORunassignedConv"></div>
		<div class="grid-item" id="ORonlineAgents"></div>
		<div class="grid-item" id="ORawayAgents"></div>
		<div class="grid-item" id="ORsoonAgents"></div>
		<div class="grid-item" id="ORslots"></div>
	</div>

	<div class="grid-bright">
  		<div class="grid-item-left">Outbound_fixed</div>
  		<div class="grid-item" id="OFopenConv"></div>
		<div class="grid-item" id="OFassignedConv"></div>
		<div class="grid-item" id="OFunassignedConv"></div>
		<div class="grid-item" id="OFonlineAgents"></div>
		<div class="grid-item" id="OFawayAgents"></div>
		<div class="grid-item" id="OFsoonAgents"></div>
		<div class="grid-item" id="OFslots"></div>
	</div>

	<div class="grid-dark">
  		<div class="grid-item-left">Outbound_fixed_risvegliate</div>
  		<div class="grid-item" id="OFRopenConv"></div>
		<div class="grid-item" id="OFRassignedConv"></div>
		<div class="grid-item" id="OFRunassignedConv"></div>
		<div class="grid-item" id="OFRonlineAgents"></div>
		<div class="grid-item" id="OFRawayAgents"></div>
		<div class="grid-item" id="OFRsoonAgents"></div>
		<div class="grid-item" id="OFRslots"></div>
	</div>

	<div class="grid-tot">
  		<div class="grid-item-left">Totale</div>
  		<div class="grid-item" id="TOopenConv"></div>
		<div class="grid-item" id="TOassignedConv"></div>
		<div class="grid-item" id="TOunassignedConv"></div>
		<div class="grid-item" id="TOonlineAgents"></div>
		<div class="grid-item" id="TOawayAgents"></div>
		<div class="grid-item" id="TOsoonAgents"></div>
		<div class="grid-item" id="TOslots"></div>
	</div></br>

	<div class="grid-container-header">
		<div class="grid-title-left">Other</div> 
  		<div class="grid-item-left">skill</div>  
  		<div class="grid-item" id="openConv">open</div>
		<div class="grid-item" id="assignedConv">assigned</div>
  		<div class="grid-item" id="unassignedConv">unassigned</div>
		<div class="grid-item" id="onlineAgents">online</div>
		<div class="grid-item" id="awayAgents">away</div>
		<div class="grid-item" id="backsoonAgents">back soon</div>
		<div class="grid-item" id="maxSlots">slots</div>
	</div>

	<div class="grid-bright">
  		<div class="grid-item-left">Inglese</div>
  		<div class="grid-item" id="IopenConv"></div>
		<div class="grid-item" id="IassignedConv"></div>
		<div class="grid-item" id="IunassignedConv"></div>
		<div class="grid-item" id="IonlineAgents"></div>
		<div class="grid-item" id="IawayAgents"></div>
		<div class="grid-item" id="IsoonAgents"></div>
		<div class="grid-item" id="Islots"></div>
	</div>
	<div class="grid-dark">
  		<div class="grid-item-left">Inglese_Chat</div>
  		<div class="grid-item" id="ICopenConv"></div>
		<div class="grid-item" id="ICassignedConv"></div>
		<div class="grid-item" id="ICunassignedConv"></div>
		<div class="grid-item" id="IConlineAgents"></div>
		<div class="grid-item" id="ICawayAgents"></div>
		<div class="grid-item" id="ICsoonAgents"></div>
		<div class="grid-item" id="ICslots"></div>
	</div>
	<div class="grid-bright">
  		<div class="grid-item-left">Priority</div>
  		<div class="grid-item" id="PopenConv"></div>
		<div class="grid-item" id="PassignedConv"></div>
		<div class="grid-item" id="PunassignedConv"></div>
		<div class="grid-item" id="PonlineAgents"></div>
		<div class="grid-item" id="PawayAgents"></div>
		<div class="grid-item" id="PsoonAgents"></div>
		<div class="grid-item" id="Pslots"></div>
	</div>

	<div class="grid-tot">
  		<div class="grid-item-left">Totale</div>
  		<div class="grid-item" id="TOtheropenConv"></div>
		<div class="grid-item" id="TOtherassignedConv"></div>
		<div class="grid-item" id="TOtherunassignedConv"></div>
		<div class="grid-item" id="TOtheronlineAgents"></div>
		<div class="grid-item" id="TOtherawayAgents"></div>
		<div class="grid-item" id="TOthersoonAgents"></div>
		<div class="grid-item" id="TOtherslots"></div>
	</div>

	</br>
	<div id="slotsAvailable"></div></br></br>

	<div id="offlineAssignedAgent"></div>

	</br></br></br></br>

    </div>


  
    <h2>Download the transcripts:</h2>
    <label><b>Start date</b></label></br>

    <input id="startdate" type="date" />
    <input id="starthour" type="time">
    </br>

    <label><b>End date</b></label></br>

    <input id="enddate" type="date" />
    <input id="endhour" type="time">
    

    </br></br>
    <select name="DropDownTimezone" id="DropDownTimezone">
      <option>(GMT +1:00 hour) Rome, Brussels, Copenhagen, Madrid, Paris</option>
      <option>(GMT +2:00) Kaliningrad, South Africa</option>
      <option>(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg</option>
      <option>(GMT +3:30) Tehran</option>
      <option>(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi</option>
      <option>(GMT +4:30) Kabul</option>
      <option>(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent</option>
      <option>(GMT +5:30) Bombay, Calcutta, Madras, New Delhi</option>
      <option>(GMT +6:00) Almaty, Dhaka, Colombo</option>
      <option>(GMT +7:00) Bangkok, Hanoi, Jakarta</option>
      <option>(GMT +8:00) Beijing, Perth, Singapore, Hong Kong</option>
      <option>(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk</option>
      <option>(GMT +9:30) Adelaide, Darwin</option>
      <option>(GMT +10:00) Eastern Australia, Guam, Vladivostok</option>
      <option>(GMT +11:00) Magadan, Solomon Islands, New Caledonia</option>
      <option>(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka</option>
      <option>(GMT -12:00) Eniwetok, Kwajalein</option>
      <option>(GMT -11:00) Midway Island, Samoa</option>
      <option>(GMT -10:00) Hawaii</option>
      <option>(GMT -9:00) Alaska</option>
      <option>(GMT -8:00) Pacific Time (US &amp; Canada)</option>
      <option>(GMT -7:00) Mountain Time (US &amp; Canada)</option>
      <option>(GMT -6:00) Central Time (US &amp; Canada), Mexico City</option>
      <option>(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima</option>
      <option>(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz</option>
      <option>(GMT -3:30) Newfoundland</option>
      <option>(GMT -3:00) Brazil, Buenos Aires, Georgetown</option>
      <option>(GMT -2:00) Mid-Atlantic</option>
      <option>(GMT -1:00 hour) Azores, Cape Verde Islands</option>
      <option>(GMT) Western Europe Time, London, Lisbon, Casablanca</option>
    </select>
    </br></br>


    <label><b>Options: </b></label>
    <select id="transcriptOptions">
        <option>Open</option>
        <option>Close</option>
        <option>Open+Close</option>
    </select>

    </br></br>

    <button type="button" id ="downloadTranscripts" class="downloadTranscripts" disabled>Download</button></br></br>
    <div id="reportMSG"></div>
    </br></br></br>

	

	<div id="unassignedConversationsList"></div>

	</br></br>

	<div id="assignedConversationsList"></div>

    </br></br></br>

    <a id="hiddenbutton" style="visibility:hidden;" href="">Hidden</a>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script>
  
  var uri = "";
  var facadeUri = "";
  var accountReadWrite = "";
  var timeZone = "";
  var skillNumber = "-1";
  var teamNumber = 0;
  var skillArray = [];
  var teamArray = [];
  var alberoArray = [];
  var uname;
  var pwd;
  var csrf;
  var accnumb = localStorage.getItem('account_number');
  var bearer = localStorage.getItem('bearer');
  var statisticOptions = 0;
  var customDate;
  var endCustomDate;
  var overwriteHumanSkill = "";
  var FacebookBotID = "1089636032";
  var exportObject = [];
  var agentLogged = [];
  var agentAssigned = [];
  var myFileToXLS = "";
	
  function findBulk(Seconds){
	 if (Seconds <= 30){
		return 1; 
	 }
	  else if (Seconds <= 60){
		return 2;  
	  }
	  else{
		return 3;  
	  }
  }
	
	
  
	
 
	
function herokuOrNot() {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("readystatechange", function () {
          	if (this.readyState === 4) {
			if (this.status == 200 && xhr.status < 300){
				document.getElementById("reportHeroku").innerHTML = "Il servizio di hosting del bot e' up";
				document.getElementById("reportHeroku").style = "color : green";
				document.getElementById("reportHeroku").style.fontWeight = "bold";
				document.getElementById("reportHeroku").style.fontSize = "large";
			}
			else{
				document.getElementById("reportHeroku").innerHTML = "Il servizio di hosting del bot e' down";
				document.getElementById("reportHeroku").style = "color : red";
				document.getElementById("reportHeroku").style.fontWeight = "bold";
				document.getElementById("reportHeroku").style.fontSize = "large";
			}
          	}
		else {
            		document.getElementById("reportHeroku").innerHTML = "...checking hosting bot status...";
            		document.getElementById("reportHeroku").style = "color : black";
			document.getElementById("reportHeroku").style.fontWeight = "bold";
			document.getElementById("reportHeroku").style.fontSize = "large";
          	}
        });
        var URLforGET = "https://vodafonebotdario.herokuapp.com/ping?ping=true&username=" + localStorage.getItem('username');
	xhr.open("GET", URLforGET);
        xhr.send();
}
	
	
function botOrNot() {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("readystatechange", function () {
          	if (this.readyState === 4) {
			if (this.status == 200 && xhr.status < 300){
				document.getElementById("reportBot").innerHTML = "Il bot e' connesso";
				document.getElementById("reportBot").style = "color : green";
				document.getElementById("reportBot").style.fontWeight = "bold";
				document.getElementById("reportBot").style.fontSize = "large";
			}
			else{
				document.getElementById("reportBot").innerHTML = "Il bot non e' connesso";
				document.getElementById("reportBot").style = "color : red";
				document.getElementById("reportBot").style.fontWeight = "bold";
				document.getElementById("reportBot").style.fontSize = "large";
			}
          	}
		else {
            		document.getElementById("reportBot").innerHTML = "...checking bot status...";
            		document.getElementById("reportBot").style = "color : black";
			document.getElementById("reportBot").style.fontWeight = "bold";
			document.getElementById("reportBot").style.fontSize = "large";
          	}
        });
        var URLforGET = "https://vodafonebotdario.herokuapp.com/add?retrieve=1&visitorID=0&convID=0";
	xhr.open("GET", URLforGET);
        xhr.send();
}
	
	
	
function retrieveAgentsLogged(){
	
	var FBPonlineAgents = 0;
	var FBPawayAgents = 0;
	var FBPsoonAgents = 0;
	var FBPslots =0;
	var FBRonlineAgents = 0;
	var FBRawayAgents = 0;
	var FBRsoonAgents = 0;
	var FBRslots =0;
	var FBPNonlineAgents = 0;
	var FBPNawayAgents = 0;
	var FBPNsoonAgents = 0;
	var FBPNslots =0;
	var FBPNRonlineAgents = 0;
	var FBPNRawayAgents = 0;
	var FBPNRsoonAgents = 0;
	var FBPNRslots =0;
	var FIXonlineAgents = 0;
	var FIXawayAgents = 0;
	var FIXsoonAgents = 0;
	var FIXslots =0;
	var FIXRonlineAgents = 0;
	var FIXRawayAgents = 0;
	var FIXRsoonAgents = 0;
	var FIXRslots =0;
	var HonlineAgents = 0;
	var HawayAgents = 0;
	var HsoonAgents = 0;
	var Hslots =0;
	var HRonlineAgents = 0;
	var HRawayAgents = 0;
	var HRsoonAgents = 0;
	var HRslots =0;
	var HNonlineAgents = 0;
	var HNawayAgents = 0;
	var HNsoonAgents = 0;
	var HNslots =0;
	var HNRonlineAgents = 0;
	var HNRawayAgents = 0;
	var HNRsoonAgents = 0;
	var HNRslots =0;
	var OonlineAgents = 0;
	var OawayAgents = 0;
	var OsoonAgents = 0;
	var Oslots =0;
	var ORonlineAgents = 0;
	var ORawayAgents = 0;
	var ORsoonAgents = 0;
	var ORslots =0;
	var OFonlineAgents = 0;
	var OFawayAgents = 0;
	var OFsoonAgents = 0;
	var OFslots =0;
	var OFRonlineAgents = 0;
	var OFRawayAgents = 0;
	var OFRsoonAgents = 0;
	var OFRslots =0;
	var IonlineAgents = 0;
	var IawayAgents = 0;
	var IsoonAgents = 0;
	var Islots = 0;
	var IConlineAgents = 0;
	var ICawayAgents = 0;
	var ICsoonAgents = 0;
	var ICslots = 0;
	var PonlineAgents = 0;
	var PawayAgents = 0;
	var PsoonAgents = 0;
	var Pslots = 0;
	var TFBonlineAgents = 0;
	var TWebonlineAgents = 0;
	var TOonlineAgents = 0;
	var TOtheronlineAgents = 0;
	var TFBawayAgents = 0;
	var TWebawayAgents = 0;
	var TOawayAgents = 0;
	var TOtherawayAgents = 0;
	var TFBsoonAgents = 0;
	var TWebsoonAgents = 0;
	var TOsoonAgents = 0;
	var TOthersoonAgents = 0;
	var TFBslots = 0;
	var TWebslots = 0;
	var TOslots = 0;
	var TOtherslots = 0;
	
	var body = '{"skillIds":["1089726032","1096374632","1102673132","1102673332","987637232","1096374432","1105369932","1105551632","1093097632","1096374732","1105849832","1105849932","1097496532","1012134132","1111294132","1111905932","1117781232","1117781332","1151792232"]}';
	var totalSpots = 0;
	var availableSpots = 0;
	
	agentLogged = [];
	
	setTimeout(function(){
		  
		  $.ajax({
			  url: "https://lo.msghist.liveperson.net/messaging_history/api/account/13099967/agent-view/status",
			  method: "POST",
			  jsonp: "cb",
			  jsonpCallback: "domainCallback",
			  cache: true,
			  contentType: "application/json",
			  "If-Match": "-1",
			  data: body,
			  success: function success(data) {
				  // console.log("********");
				  loadConvs();
				  console.log(JSON.stringify(data));
				  if(data.hasOwnProperty('_metadata')){
					  if(data._metadata.hasOwnProperty('count')){
						  if(data._metadata.count > 0){
							  if(data.hasOwnProperty('agentStatusRecords')){
								  var agentStatusRecordsLength = data.agentStatusRecords.length;
								  for (var z = 0; z < agentStatusRecordsLength; z++){
									  agentLogged.push(data.agentStatusRecords[z].agentName.replace("  ", " "));
									  var FBcounted = false;
									  var Hcounted = false;
									  var Ocounted = false;
									  var Othercounted = false;
									  totalSpots = (data.agentStatusRecords[z].configuredMaxSlots) - (data.agentStatusRecords[z].busySlots);
									  availableSpots = availableSpots + totalSpots;
									  var skillLength = data.agentStatusRecords[z].agentSkills.length;
									  var statusAgent = data.agentStatusRecords[z].currentStatus;
									  for (var m = 0; m < skillLength; m++){
										  if (data.agentStatusRecords[z].agentSkills[m].skillId === "-1"){
											 // do nothing 
										  } else{
											  var currentSkill = data.agentStatusRecords[z].agentSkills[m].skillName;
											  switch(currentSkill) {
													  case "Facebook_priv":
													  switch(statusAgent) {
															  case "ONLINE":
															  FBPonlineAgents = FBPonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FBPslots = FBPslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  FBPawayAgents = FBPawayAgents + 1;
															  if(!FBcounted){
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FBPsoonAgents = FBPsoonAgents + 1;
															  if(!FBcounted){  
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "facebook_risvegliate":
													  switch(statusAgent) {
															  case "ONLINE":
															  FBRonlineAgents = FBRonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FBRslots = FBRslots + totalSpots;
															  
															  break;
															  case "AWAY":
															  FBRawayAgents = FBRawayAgents + 1;
															  if(!FBcounted){
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FBRsoonAgents = FBRsoonAgents + 1;
															  if(!FBcounted){
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Facebook_priv_night":
													  switch(statusAgent) {
															  case "ONLINE":
															  FBPNonlineAgents = FBPNonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FBPNslots = FBPNslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  FBPNawayAgents = FBPNawayAgents + 1;
															  if(!FBcounted){
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FBPNsoonAgents = FBPNsoonAgents + 1;
															  if(!FBcounted){
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Facebook_priv_night_risvegli":
													  switch(statusAgent) {
															  case "ONLINE":
															  FBPNRonlineAgents = FBPNRonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FBPNRslots = FBPNRslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  FBPNRawayAgents = FBPNRawayAgents + 1;
															  if(!FBcounted){
																  
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FBPNRsoonAgents = FBPNRsoonAgents + 1;
															  if(!FBcounted){
																  
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Fixed":
													  switch(statusAgent) {
															  case "ONLINE":
															  FIXonlineAgents = FIXonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FIXslots = FIXslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  FIXawayAgents = FIXawayAgents + 1;
															  if(!FBcounted){
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FIXsoonAgents = FIXsoonAgents + 1;
															  if(!FBcounted){  
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Fixed_risvegliata":
													  switch(statusAgent) {
															  case "ONLINE":
															  FIXRonlineAgents = FIXRonlineAgents + 1;
															  if(!FBcounted){
																  TFBonlineAgents = TFBonlineAgents + 1;
																  TFBslots = TFBslots + totalSpots;
																  FBcounted = true;
															  }
															  FIXRslots = FIXRslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  FIXRawayAgents = FIXRawayAgents + 1;
															  if(!FBcounted){
																  TFBawayAgents = TFBawayAgents + 1;
																  FBcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  FIXRsoonAgents = FIXRsoonAgents + 1;
															  if(!FBcounted){  
																  TFBsoonAgents = TFBsoonAgents + 1;
																  FBcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "human":
													  switch(statusAgent) {
															  case "ONLINE":
															  HonlineAgents = HonlineAgents + 1;
															  if(!Hcounted){
																  TWebonlineAgents = TWebonlineAgents + 1;
																  TWebslots = TWebslots + totalSpots;
																  Hcounted = true;
															  }
															  Hslots = Hslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  HawayAgents = HawayAgents + 1;
															  if(!Hcounted){
																  TWebawayAgents = TWebawayAgents + 1;
																  Hcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  HsoonAgents = HsoonAgents + 1;
															  if(!Hcounted){
																  TWebsoonAgents = TWebsoonAgents + 1;
																  Hcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "human_risvegliate":
													  switch(statusAgent) {
															  case "ONLINE":
															  HRonlineAgents = HRonlineAgents + 1;
															  if(!Hcounted){
																  TWebonlineAgents = TWebonlineAgents + 1;
																  TWebslots = TWebslots + totalSpots;
																  Hcounted = true;
															  }
															  HRslots = HRslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  HRawayAgents = HRawayAgents + 1;
															  if(!Hcounted){
																  TWebawayAgents = TWebawayAgents + 1;
																  Hcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  HRsoonAgents = HRsoonAgents + 1;
															  if(!Hcounted){
																  TWebsoonAgents = TWebsoonAgents + 1;
																  Hcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "human_night":
													  switch(statusAgent) {
															  case "ONLINE":
															  HNonlineAgents = HNonlineAgents + 1;
															  if(!Hcounted){
																  TWebonlineAgents = TWebonlineAgents + 1;
																  TWebslots = TWebslots + totalSpots;
																  Hcounted = true;
															  }
															  HNslots = HNslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  HNawayAgents = HNawayAgents + 1;
															  if(!Hcounted){
																  TWebawayAgents = TWebawayAgents + 1;
																  Hcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  HNsoonAgents = HNsoonAgents + 1;
															  if(!Hcounted){
																  TWebsoonAgents = TWebsoonAgents + 1;
																  Hcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "human_night_risvegliate":
													  switch(statusAgent) {
															  case "ONLINE":
															  HNRonlineAgents = HNRonlineAgents + 1;
															  if(!Hcounted){
																  TWebonlineAgents = TWebonlineAgents + 1;
																  TWebslots = TWebslots + totalSpots;
																  Hcounted = true;
															  }
															  HNRslots = HNRslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  HNRawayAgents = HNRawayAgents + 1;
															  if(!Hcounted){
																  TWebawayAgents = TWebawayAgents + 1;
																  Hcounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  HNRsoonAgents = HNRsoonAgents + 1;
															  if(!Hcounted){
																  TWebsoonAgents = TWebsoonAgents + 1;
																  Hcounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Outbound":
													  switch(statusAgent) {
															  case "ONLINE":
															  OonlineAgents = OonlineAgents + 1;
															  if(!Ocounted){
																  TOonlineAgents = TOonlineAgents + 1;
																  TOslots = TOslots + totalSpots;
																  Ocounted = true;
															  }
															  Oslots = Oslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  OawayAgents = OawayAgents + 1;
															  if(!Ocounted){
																  TOawayAgents = TOawayAgents + 1;
																  Ocounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  OsoonAgents = OsoonAgents + 1;
															  if(!Ocounted){
																  TOsoonAgents = TOsoonAgents + 1;
																  Ocounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "outbound_risvegliate":
													  switch(statusAgent) {
															  case "ONLINE":
															  ORonlineAgents = ORonlineAgents + 1;
															  if(!Ocounted){
																  TOonlineAgents = TOonlineAgents + 1;
																  TOslots = TOslots + totalSpots;
																  Ocounted = true;
															  }
															  ORslots = ORslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  ORawayAgents = ORawayAgents + 1;
															  if(!Ocounted){
																  TOawayAgents = TOawayAgents + 1;
																  Ocounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  ORsoonAgents = ORsoonAgents + 1;
															  if(!Ocounted){
																  TOsoonAgents = TOsoonAgents + 1;
																  Ocounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Outbound_fixed":
													  switch(statusAgent) {
															  case "ONLINE":
															  OFonlineAgents = OFonlineAgents + 1;
															  if(!Ocounted){
																  TOonlineAgents = TOonlineAgents + 1;
																  TOslots = TOslots + totalSpots;
																  Ocounted = true;
															  }
															  OFslots = OFslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  OFawayAgents = OFawayAgents + 1;
															  if(!Ocounted){
																  TOawayAgents = TOawayAgents + 1;
																  Ocounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  OFsoonAgents = OFsoonAgents + 1;
															  if(!Ocounted){
																  TOsoonAgents = TOsoonAgents + 1;
																  Ocounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Outbound_fixed_risvegliate":
													  switch(statusAgent) {
															  case "ONLINE":
															  OFRonlineAgents = OFRonlineAgents + 1;
															  if(!Ocounted){
																  TOonlineAgents = TOonlineAgents + 1;
																  TOslots = TOslots + totalSpots;
																  Ocounted = true;
															  }
															  OFRslots = OFRslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  OFRawayAgents = OFRawayAgents + 1;
															  if(!Ocounted){
																  TOawayAgents = TOawayAgents + 1;
																  Ocounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  OFRsoonAgents = OFRsoonAgents + 1;
															  if(!Ocounted){
																  TOsoonAgents = TOsoonAgents + 1;
																  Ocounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Inglese":
													  switch(statusAgent) {
															  case "ONLINE":
															  IonlineAgents = IonlineAgents + 1;
															  if(!Othercounted){
																  TOtheronlineAgents = TOtheronlineAgents + 1;
																  TOtherslots = TOtherslots + totalSpots;
																  Othercounted = true;
															  }
															  Islots = Islots + totalSpots;
															  break;
															  
															  case "AWAY":
															  IawayAgents = IawayAgents + 1;
															  if(!Othercounted){
																  TOtherawayAgents = TOtherawayAgents + 1;
																  Othercounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  IsoonAgents = IsoonAgents + 1;
															  if(!Othercounted){
																  TOthersoonAgents = TOthersoonAgents + 1;
																  Othercounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Inglese_chat":
													  switch(statusAgent) {
															  case "ONLINE":
															  IConlineAgents = IConlineAgents + 1;
															  if(!Othercounted){
																  TOtheronlineAgents = TOtheronlineAgents + 1;
																  TOtherslots = TOtherslots + totalSpots;
																  Othercounted = true;
															  }
															  ICslots = ICslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  ICawayAgents = ICawayAgents + 1;
															  if(!Othercounted){
																  TOtherawayAgents = TOtherawayAgents + 1;
																  Othercounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  ICsoonAgents = ICsoonAgents + 1;
															  if(!Othercounted){
																  TOthersoonAgents = TOthersoonAgents + 1;
																  Othercounted = true;
															  }
															  break;	  
													  }
													  break;
													  
													  case "Priority":
													  switch(statusAgent) {
															  case "ONLINE":
															  PonlineAgents = PonlineAgents + 1;
															  if(!Othercounted){
																  TOtheronlineAgents = TOtheronlineAgents + 1;
																  TOtherslots = TOtherslots + totalSpots;
																  Othercounted = true;
															  }
															  Pslots = Pslots + totalSpots;
															  break;
															  
															  case "AWAY":
															  PawayAgents = PawayAgents + 1;
															  if(!Othercounted){
																  TOtherawayAgents = TOtherawayAgents + 1;
																  Othercounted = true;
															  }
															  break;
															  
															  case "BACK_SOON":
															  PsoonAgents = PsoonAgents + 1;
															  if(!Othercounted){
																  TOthersoonAgents = TOthersoonAgents + 1;
																  Othercounted = true;
															  }
															  break;	  
													  }
													  break;
													  
											  }
											  
											  
										  }
									  }
									  
								  }
							  }
						  }
					  }
				  }
				  document.getElementById("slotsAvailable").innerHTML = "Sessioni disponibili: " + (Math.round(availableSpots * 100) / 100);
				  document.getElementById("slotsAvailable").style = "color : green";
				  document.getElementById("slotsAvailable").style.fontWeight = "bold";
				  document.getElementById("slotsAvailable").style.fontSize = "large";
				  document.getElementById("FBPonlineAgents").innerHTML = FBPonlineAgents;
				  document.getElementById("FBPawayAgents").innerHTML = FBPawayAgents;
				  document.getElementById("FBPsoonAgents").innerHTML = FBPsoonAgents;
				  FBPslots = (Math.round(FBPslots * 100) / 100);
				  document.getElementById("FBPslots").innerHTML = FBPslots;
				  document.getElementById("FBRonlineAgents").innerHTML = FBRonlineAgents;
				  document.getElementById("FBRawayAgents").innerHTML = FBRawayAgents;
				  document.getElementById("FBRsoonAgents").innerHTML = FBRsoonAgents;
				  FBRslots = (Math.round(FBRslots * 100) / 100);
				  document.getElementById("FBRslots").innerHTML = FBRslots;
				  document.getElementById("FBPNonlineAgents").innerHTML = FBPNonlineAgents;
				  document.getElementById("FBPNawayAgents").innerHTML = FBPNawayAgents;
				  document.getElementById("FBPNsoonAgents").innerHTML = FBPNsoonAgents;
				  FBPNslots = (Math.round(FBPNslots * 100) / 100);
				  document.getElementById("FBPNslots").innerHTML = FBPNslots;
				  document.getElementById("FBPNRonlineAgents").innerHTML = FBPNRonlineAgents;
				  document.getElementById("FBPNRawayAgents").innerHTML = FBPNRawayAgents;
				  document.getElementById("FBPNRsoonAgents").innerHTML = FBPNRsoonAgents;
				  FBPNRslots = (Math.round(FBPNRslots * 100) / 100);
				  document.getElementById("FBPNRslots").innerHTML = FBPNRslots;
				  document.getElementById("FIXonlineAgents").innerHTML = FIXonlineAgents;
				  document.getElementById("FIXawayAgents").innerHTML = FIXawayAgents;
				  document.getElementById("FIXsoonAgents").innerHTML = FIXsoonAgents;
				  FIXslots = (Math.round(FIXslots * 100) / 100);
				  document.getElementById("FIXslots").innerHTML = FIXslots;
				  document.getElementById("FIXRonlineAgents").innerHTML = FIXRonlineAgents;
				  document.getElementById("FIXRawayAgents").innerHTML = FIXRawayAgents;
				  document.getElementById("FIXRsoonAgents").innerHTML = FIXRsoonAgents;
				  FIXRslots = (Math.round(FIXRslots * 100) / 100);
				  document.getElementById("FIXRslots").innerHTML = FIXRslots;
				  document.getElementById("HonlineAgents").innerHTML = HonlineAgents;
				  document.getElementById("HawayAgents").innerHTML = HawayAgents;
				  document.getElementById("HsoonAgents").innerHTML = HsoonAgents;
				  Hslots = (Math.round(Hslots * 100) / 100);
				  document.getElementById("Hslots").innerHTML = Hslots;
				  document.getElementById("HRonlineAgents").innerHTML = HRonlineAgents;
				  document.getElementById("HRawayAgents").innerHTML = HRawayAgents;
				  document.getElementById("HRsoonAgents").innerHTML = HRsoonAgents;
				  HRslots = (Math.round(HRslots * 100) / 100);
				  document.getElementById("HRslots").innerHTML = HRslots;
				  document.getElementById("HNonlineAgents").innerHTML = HNonlineAgents;
				  document.getElementById("HNawayAgents").innerHTML = HNawayAgents;
				  document.getElementById("HNsoonAgents").innerHTML = HNsoonAgents;
				  HNslots = (Math.round(HNslots * 100) / 100);
				  document.getElementById("HNslots").innerHTML = HNslots;
				  document.getElementById("HNRonlineAgents").innerHTML = HNRonlineAgents;
				  document.getElementById("HNRawayAgents").innerHTML = HNRawayAgents;
				  document.getElementById("HNRsoonAgents").innerHTML = HNRsoonAgents;
				  HNRslots = (Math.round(HNRslots * 100) / 100);
				  document.getElementById("HNRslots").innerHTML = HNRslots;
				  document.getElementById("OonlineAgents").innerHTML = OonlineAgents;
				  document.getElementById("OawayAgents").innerHTML = OawayAgents;
				  document.getElementById("OsoonAgents").innerHTML = OsoonAgents;
				  Oslots = (Math.round(Oslots * 100) / 100);
				  document.getElementById("Oslots").innerHTML = Oslots;
				  document.getElementById("ORonlineAgents").innerHTML = ORonlineAgents;
				  document.getElementById("ORawayAgents").innerHTML = ORawayAgents;
				  document.getElementById("ORsoonAgents").innerHTML = ORsoonAgents;
				  ORslots = (Math.round(ORslots * 100) / 100);
				  document.getElementById("ORslots").innerHTML = ORslots;
				  document.getElementById("OFonlineAgents").innerHTML = OFonlineAgents;
				  document.getElementById("OFawayAgents").innerHTML = OFawayAgents;
				  document.getElementById("OFsoonAgents").innerHTML = OFsoonAgents;
				  OFslots = (Math.round(OFslots * 100) / 100);
				  document.getElementById("OFslots").innerHTML = OFslots;
				  document.getElementById("OFRonlineAgents").innerHTML = OFRonlineAgents;
				  document.getElementById("OFRawayAgents").innerHTML = OFRawayAgents;
				  document.getElementById("OFRsoonAgents").innerHTML = OFRsoonAgents;
				  OFRslots = (Math.round(OFRslots * 100) / 100);
				  document.getElementById("OFRslots").innerHTML = OFRslots;
				  document.getElementById("IonlineAgents").innerHTML = IonlineAgents;
				  document.getElementById("IawayAgents").innerHTML = IawayAgents;
				  document.getElementById("IsoonAgents").innerHTML = IsoonAgents;
				  Islots = (Math.round(Islots * 100) / 100);
				  document.getElementById("Islots").innerHTML = Islots;
				  document.getElementById("IConlineAgents").innerHTML = IConlineAgents;
				  document.getElementById("ICawayAgents").innerHTML = ICawayAgents;
				  document.getElementById("ICsoonAgents").innerHTML = ICsoonAgents;
				  ICslots = (Math.round(ICslots * 100) / 100);
				  document.getElementById("ICslots").innerHTML = ICslots;
				  document.getElementById("PonlineAgents").innerHTML = PonlineAgents;
				  document.getElementById("PawayAgents").innerHTML = PawayAgents;
				  document.getElementById("PsoonAgents").innerHTML = PsoonAgents;
				  Pslots = (Math.round(Pslots * 100) / 100);
				  document.getElementById("Pslots").innerHTML = Pslots;
				  document.getElementById("TFBonlineAgents").innerHTML = TFBonlineAgents;
				  document.getElementById("TWebonlineAgents").innerHTML = TWebonlineAgents;
				  document.getElementById("TOonlineAgents").innerHTML = TOonlineAgents;
				  document.getElementById("TOtheronlineAgents").innerHTML = TOtheronlineAgents;
				  document.getElementById("TFBawayAgents").innerHTML = TFBawayAgents;
				  document.getElementById("TWebawayAgents").innerHTML = TWebawayAgents;
				  document.getElementById("TOawayAgents").innerHTML = TOawayAgents;
				  document.getElementById("TOtherawayAgents").innerHTML = TOtherawayAgents;
				  document.getElementById("TFBsoonAgents").innerHTML = TFBsoonAgents;
				  document.getElementById("TWebsoonAgents").innerHTML = TWebsoonAgents;
				  document.getElementById("TOsoonAgents").innerHTML = TOsoonAgents;
				  document.getElementById("TOthersoonAgents").innerHTML = TOthersoonAgents;
				  document.getElementById("TFBslots").innerHTML = (Math.round(TFBslots * 100) / 100);
				  document.getElementById("TWebslots").innerHTML = (Math.round(TWebslots * 100) / 100);
				  document.getElementById("TOslots").innerHTML = (Math.round(TOslots * 100) / 100);
				  document.getElementById("TOtherslots").innerHTML = (Math.round(TOtherslots * 100) / 100);
				  
	  
	  
	  
			  },
			  error: function error(e, text) {
				  localStorage.setItem('account_number', '');
				  location.reload();
			  },
			  beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		  });
                       
	}, 3000);
	
	
}
	
	
	
	
  function loadLimboBar(){
	  
	 var howManyLimbo = 0; 
	 var howManyUnassigned = 0;
	 var body = body = '{"start":{"from":' + (Date.now() - (1000*60*60*24*30)) + ',"to":' + (Date.now()) + '}, "status": ["OPEN"]}';
	 var offset = 0;
	  
	 $.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      herokuOrNot();
				      botOrNot();
				      if((data._metadata.count) > 0){
					      var length = data.conversationHistoryRecords.length;
					      for (var m = 0; m < length; m++){
						      if((data.conversationHistoryRecords[m].info.latestSkillName) === "Limbo"){
							      howManyLimbo = howManyLimbo + 1;
						      }
						      else{
							      if((data.conversationHistoryRecords[m].info.latestAgentLoginName) === "NA"){
								      howManyUnassigned = howManyUnassigned + 1;
							      }   
						      }
					      }
				      }
				      document.getElementById("limbo").innerHTML = howManyLimbo;
				      document.getElementById("unassigned").innerHTML = howManyUnassigned;
                              },
                              error: function error(e, text) {
		 
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	  
  }
	
  function loadBar(){
	  
	  setTimeout(function(){
		  
	      	$.ajax({
                    url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/facadeMsg/baseURI.lpCsds?version=1.0",
                    jsonp: "cb",
                    jsonpCallback: "domainCallback",
                    cache: true,
                    dataType: "jsonp",
                    success: function success(data) {
			loadLimboBar();
                        if('lpCallError' in data.ResultSet){
				localStorage.setItem('account_number', '');
			   	location.reload(); 
                        }
                        else{
                           	facadeUri = data.ResultSet.lpData[0].lpServer;
                           	$.ajax({
                              		url: "https://" + facadeUri + "/api/messaging/rest/reporting/brands/" + accnumb + "/msgstatistics?v=1",
                              		method: "GET",
                              		jsonp: "cb",
                              		jsonpCallback: "domainCallback",
                              		cache: true,
                              		contentType: "application/json",
                              		success: function success(data) {
						document.getElementById("open").innerHTML = data.active;
						document.getElementById("pending").innerHTML = data.pending;
						document.getElementById("overdue").innerHTML = data.overdue;
						document.getElementById("soonOverdue").innerHTML = data.soonToOverdue;
                              		},
                              		error: function error(e, text) {
						localStorage.setItem('account_number', '');
				    		location.reload(); 
                              		},
                              		beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          	});   
                        }
                    },
                    error: function error(e, text) {
			    console.log(text);
			    localStorage.setItem('account_number', '');
			    location.reload(); 
                    }
              	});
	}, 1000);
  }
	
  function loadSkills(){
	  
	  setTimeout(function(){
		  
	      	$.ajax({
                    url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/accountConfigReadWrite/baseURI.lpCsds?version=1.0",
                    jsonp: "cb",
                    jsonpCallback: "domainCallback",
                    cache: true,
                    dataType: "jsonp",
                    success: function success(data) {
                        if('lpCallError' in data.ResultSet){
				localStorage.setItem('account_number', '');
			   	location.reload(); 
                        }
                        else{
                           	accountReadWrite = data.ResultSet.lpData[0].lpServer;
                           	$.ajax({
                              		url: "https://" + accountReadWrite + "/api/account/" + accnumb + "/configuration/le-users/skills",
                              		method: "GET",
                              		jsonp: "cb",
                              		jsonpCallback: "domainCallback",
                              		cache: true,
                              		contentType: "application/json",
                              		success: function success(data) {
						skillArray = data;
						var appendSkill = '<select name="skillSelector" id="skillName"><option>All</option>';
						var toAppend = '';
						var newHuman = '';
						var toAppendHuman = '';
						var length = data.length;
						for (var m = 0; m < length; m++){
							if(!data[m].name.startsWith("***")){
								toAppend = '<option>' + data[m].name + '</option>';
								appendSkill = appendSkill.concat(toAppend);
							}
							else{
								toAppendHuman = '","' + data[m].id;
								newHuman = newHuman.concat(toAppendHuman);
							}
						}
						// console.log("*****");
						// console.log("*****");
						// console.log(newHuman);
						// console.log("*****");
						// console.log("*****");
						overwriteHumanSkill = newHuman;
						appendSkill = appendSkill.concat('</select>');
						$("#skill").append(appendSkill);
						$('#customDate').val($('#startdate').val());
						$('#endCustomDate').val($('#enddate').val());
						$('#customHour').val("00:00");
						$('#endCustomHour').val("23:59");
						var thisDate = $('#customDate').val();
						thisDate = new Date(thisDate);
						var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
						var year = thisDate.getFullYear();
						var month = months[thisDate.getMonth()];
						var date = thisDate.getDate();
						var hour = $('#customHour').val();
						thisDate = month + " " + date + " " + year + " " + hour + timeZone;
						var d = new Date(thisDate);
						customDate = d.getTime();
						thisDate = $('#endCustomDate').val();
						thisDate = new Date(thisDate);
						months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
						year = thisDate.getFullYear();
						month = months[thisDate.getMonth()];
						date = thisDate.getDate();
						hour = $('#endCustomHour').val();
						thisDate = month + " " + date + " " + year + " " + hour + timeZone;
						d = new Date(thisDate);
						endCustomDate = d.getTime();
						
						$('#customDate,#customHour').on('change', function() {
							
							var thisDate = $('#customDate').val();
							thisDate = new Date(thisDate);
							var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
							var year = thisDate.getFullYear();
							var month = months[thisDate.getMonth()];
							var date = thisDate.getDate();
							var hour = $('#customHour').val();
							thisDate = month + " " + date + " " + year + " " + hour + timeZone;
							var d = new Date(thisDate);
							customDate = d.getTime();
						})
						$('#endCustomDate,#endCustomHour').on('change', function() {
							
							var thisDate = $('#endCustomDate').val();
							thisDate = new Date(thisDate);
							var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
							var year = thisDate.getFullYear();
							var month = months[thisDate.getMonth()];
							var date = thisDate.getDate();
							var hour = $('#endCustomHour').val();
							thisDate = month + " " + date + " " + year + " " + hour + timeZone;
							var d = new Date(thisDate);
							endCustomDate = d.getTime();
							
						})
                              		},
                              		error: function error(e, text) {
						localStorage.setItem('account_number', '');
				    		location.reload(); 
                              		},
                              		beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          	});   
                        }
                    },
                    error: function error(e, text) {
			    console.log(text);
			    localStorage.setItem('account_number', '');
			    location.reload(); 
                    }
              	});
	}, 2000);
  }
	
  function loadTeams(){
	  
	  setTimeout(function(){
		  
		  $.ajax({
			  url: "https://" + accountReadWrite + "/api/account/" + accnumb + "/configuration/le-users/agentGroups",
			  method: "GET",
			  jsonp: "cb",
			  jsonpCallback: "domainCallback",
			  cache: true,
			  contentType: "application/json",
			  "If-Match": "-1",
			  success: function success(data) {
				  teamArray = data;
				  var appendTeam = '<select name="teamSelector" id="teamName"><option>All</option>';
				  var toAppend = '';
				  var length = data.length;
				  for (var m = 0; m < length; m++){
					  toAppend = '<option>' + data[m].name + '</option>';
					  appendTeam = appendTeam.concat(toAppend);
				  }
				  appendTeam = appendTeam.concat('</select>');
				  $("#team").append(appendTeam);
				  buildAlbero(data);
			  },
			  error: function error(e, text) {
				  localStorage.setItem('account_number', '');
				  location.reload();
			  },
			  beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		  });
                       
	}, 3000);
  }
	
	
	
	
	
  function buildAlbero(agentJSON){
	  
	  var length = agentJSON.length;
	  var groupID;
	  var nameGroupFather;
	  console.log("*********************");
	  console.log("*** Albero Gruppi ***");
	  console.log("*********************");
	  for (var p = 0; p < length; p++){
		  
		  groupID = agentJSON[p].id;
		  
		  if (groupID < 0){
			  var newElementAlbero = '{"son":"Main Group","father":"Main Group"}';
			  newElementAlbero = JSON.parse(newElementAlbero);
			  alberoArray.push(newElementAlbero);
		  }
		  else{
		  
		  	$.ajax({
			  	url: "https://" + accountReadWrite + "/api/account/" + accnumb + "/configuration/le-users/agentGroups/" + groupID,
			  	method: "GET",
			  	jsonp: "cb",
			  	jsonpCallback: "domainCallback",
			  	cache: true,
			  	contentType: "application/json",
			  	"If-Match": "-1",
			  	success: function success(data) {
				  	for (var v = 0; v < length; v++){
					  	if (agentJSON[v].id === data.parentGroupId){
						  	nameGroupFather = agentJSON[v].name;
						  	var newElementAlbero = '{"son":"' + data.name + '","father":"' + nameGroupFather + '"}';
						  	newElementAlbero = JSON.parse(newElementAlbero);
						  	alberoArray.push(newElementAlbero);
					  	}
				  	}
				  	console.log(data.name + "*****" + nameGroupFather);
			  	},
			  	error: function error(e, text) {
				  	localStorage.setItem('account_number', '');
				  	location.reload();
			  	},
			  	beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		  	});
		  }
	  }
	  $("#downloadTranscripts").prop( "disabled", false );
	  setTimeout(function(){ console.log(alberoArray); }, 5000);
                       
	
  }
	
	
  function loadStats(answer){
	  var FBPopenConv = 0;
	  var FBPassignedConv = 0;
	  var FBPunassignedConv = 0;
	  var FBRopenConv =0;
	  var FBRassignedConv =0;
	  var FBRunassignedConv =0;
	  var FBPNopenConv =0;
	  var FBPNassignedConv =0;
	  var FBPNunassignedConv =0;
	  var FBPNRopenConv =0;
	  var FBPNRassignedConv =0;
	  var FBPNRunassignedConv =0;
	  var FIXopenConv =0;
	  var FIXassignedConv =0;
	  var FIXunassignedConv =0;
	  var FIXRopenConv =0;
	  var FIXRassignedConv =0;
	  var FIXRunassignedConv =0;
	  var HopenConv =0;
	  var HassignedConv =0;
	  var HunassignedConv =0;
	  var HRopenConv =0;
	  var HRassignedConv =0;
	  var HRunassignedConv =0;
	  var HNopenConv =0;
	  var HNassignedConv =0;
	  var HNunassignedConv =0;
	  var HNRopenConv =0;
	  var HNRassignedConv =0;
	  var HNRunassignedConv =0;
	  var OopenConv =0;
	  var OassignedConv =0;
	  var OunassignedConv =0;
	  var ORopenConv =0;
	  var ORassignedConv =0;
	  var ORunassignedConv =0;
	  var OFopenConv =0;
	  var OFassignedConv =0;
	  var OFunassignedConv =0;
	  var OFRopenConv =0;
	  var OFRassignedConv =0;
	  var OFRunassignedConv =0;
	  var IopenConv =0;
	  var IassignedConv =0;
	  var IunassignedConv =0;
	  var ICopenConv =0;
	  var ICassignedConv =0;
	  var ICunassignedConv =0;
	  var PopenConv =0;
	  var PassignedConv =0;
	  var PunassignedConv =0;
	  var TFBopenConv =0;
	  var TFBassignedConv =0;
	  var TFBunassignedConv =0;
	  var TWebopenConv =0;
	  var TWebassignedConv =0;
	  var TWebunassignedConv =0;
	  var TOopenConv =0;
	  var TOassignedConv =0;
	  var TOunassignedConv =0;
	  var TOtheropenConv =0;
	  var TOtherassignedConv =0;
	  var TOtherunassignedConv =0;
	  agentAssigned = [];
	  
	  var unassignedConversationsList = "Conversazioni non assegnate:";
	  var assignedConversationsList = "Conversazioni assegnate:";
	  
	  
	  
	  $('#loadingStats').css('display', 'none');
	  $('#loadedStats').css('display', 'inline');
	  var answerLength = answer.length;
	  var latestSkill = "";
	  var isAssigned = false;
	  var waitingFrom = 0;
	  var stringWaitingFrom = "";
	  for (var z = 0; z < answerLength; z++){
		  latestSkill = answer[z].info.latestSkillName;
		  
		  if(answer[z].info.latestQueueState === "IN_QUEUE"){
			  isAssigned = false;
			  if(answer[z].hasOwnProperty('transfers')){
				  var rew = answer[z].transfers.length;
				  if(rew === 0){
					  waitingFrom = Math.round((Date.now() - answer[z].info.startTimeL)/1000);
					  stringWaitingFrom = ", " + waitingFrom;
				  } else{
					  waitingFrom = Math.round((Date.now() - answer[z].transfers[(rew-1)].timeL)/1000);
					  stringWaitingFrom = ", " + waitingFrom; 
				  }
			  } else{
				  waitingFrom = Math.round((Date.now() - answer[z].info.startTimeL)/1000);
				  stringWaitingFrom = ", " + waitingFrom;	  
			  }
		  } else{
			  isAssigned = true;
			  if(!agentLogged.includes(answer[z].info.latestAgentFullName)){
				  if(!agentAssigned.includes(answer[z].info.latestAgentFullName)){
					  agentAssigned.push(answer[z].info.latestAgentFullName);
				  }
			  }
		  }
		  switch(latestSkill) {
			  case "Facebook_priv":
				  FBPopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FBPassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_priv: " + answer[z].info.conversationId + stringWaitingFrom;
					  FBPunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
				  
			case "facebook_risvegliate":
				  FBRopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FBRassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_risvegliate: " + answer[z].info.conversationId + stringWaitingFrom;
					  FBRunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
			case "Facebook_priv_night":
				  FBPNopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FBPNassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_priv_night: " + answer[z].info.conversationId + stringWaitingFrom;
					  FBPNunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
			case "Facebook_priv_night_risvegli":
				  FBPNRopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FBPNRassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_priv_night_risvegli: " + answer[z].info.conversationId + stringWaitingFrom;
					  FBPNRunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
			case "Fixed":
				  FIXopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FIXassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_priv: " + answer[z].info.conversationId + stringWaitingFrom;
					  FIXunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
			case "Fixed_risvegliata":
				  FIXRopenConv ++;
				  TFBopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  FIXRassignedConv ++;
					  TFBassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Facebook_priv: " + answer[z].info.conversationId + stringWaitingFrom;
					  FIXRunassignedConv ++;
					  TFBunassignedConv ++;
				  }
				  break;
				  
				  
				  
			case "human":
				  HopenConv ++;
				  TWebopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  HassignedConv ++;
					  TWebassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Human: " + answer[z].info.conversationId + stringWaitingFrom;
					  HunassignedConv ++;
					  TWebunassignedConv ++;
				  }
				  break;
				  
			case "human_risvegliate":
				  HRopenConv ++;
				  TWebopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  HRassignedConv ++;
					  TWebassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Human_risvegliate: " + answer[z].info.conversationId + stringWaitingFrom;
					  HRunassignedConv ++;
					  TWebunassignedConv ++;
				  }
				  break;
				  
			case "human_night":
				  HNopenConv ++;
				  TWebopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  HNassignedConv ++;
					  TWebassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Human_night: " + answer[z].info.conversationId + stringWaitingFrom;
					  HNunassignedConv ++;
					  TWebunassignedConv ++;
				  }
				  break;
				  
			case "human_night_risvegliate":
				  HNRopenConv ++;
				  TWebopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  HNRassignedConv ++;
					  TWebassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Human_night_risvegliate: " + answer[z].info.conversationId + stringWaitingFrom;
					  HNRunassignedConv ++;
					  TWebunassignedConv ++;
				  }
				  break;
				  
			case "Outbound":
				  OopenConv ++;
				  TOopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  OassignedConv ++;
					  TOassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Outbound: " + answer[z].info.conversationId + stringWaitingFrom;
					  OunassignedConv ++;
					  TOunassignedConv ++;
				  }
				  break;
				  
			case "outbound_risvegliate":
				  ORopenConv ++;
				  TOopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  ORassignedConv ++;
					  TOassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>outbound_risvegliate: " + answer[z].info.conversationId + stringWaitingFrom;
					  ORunassignedConv ++;
					  TOunassignedConv ++;
				  }
				  break;
				  
			case "Outbound_fixed":
				  OFopenConv ++;
				  TOopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  OFassignedConv ++;
					  TOassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>outbound_fixed: " + answer[z].info.conversationId + stringWaitingFrom;
					  OFunassignedConv ++;
					  TOunassignedConv ++;
				  }
				  break;
				  
			case "Outbound_fixed_risvegliate":
				  OFRopenConv ++;
				  TOopenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  OFRassignedConv ++;
					  TOassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Outbound_fixed_risvegliate: " + answer[z].info.conversationId + stringWaitingFrom;
					  OFRunassignedConv ++;
					  TOunassignedConv ++;
				  }
				  break;
				  
			case "Inglese":
				  IopenConv ++;
				  TOtheropenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  IassignedConv ++;
					  TOtherassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Inglese: " + answer[z].info.conversationId + stringWaitingFrom;
					  IunassignedConv ++;
					  TOtherunassignedConv ++;
				  }
				  break;
				  
			case "Inglese_chat":
				  ICopenConv ++;
				  TOtheropenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  ICassignedConv ++;
					  TOtherassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Inglese: " + answer[z].info.conversationId + stringWaitingFrom;
					  ICunassignedConv ++;
					  TOtherunassignedConv ++;
				  }
				  break;
				  
			case "Priority":
				  PopenConv ++;
				  TOtheropenConv ++;
				  if(isAssigned){
					  assignedConversationsList = assignedConversationsList + "<br>" + answer[z].info.latestAgentFullName + ": " + answer[z].info.conversationId;
					  PassignedConv ++;
					  TOtherassignedConv ++;
				  } else{
					  unassignedConversationsList = unassignedConversationsList + "<br>Priority: " + answer[z].info.conversationId + stringWaitingFrom;
					  PunassignedConv ++;
					  TOtherunassignedConv ++;
				  }
				  break;  	  
				  
		  }
	  }
	  document.getElementById("FBPopenConv").innerHTML = FBPopenConv;
	  document.getElementById("FBPassignedConv").innerHTML = FBPassignedConv;
	  document.getElementById("FBPunassignedConv").innerHTML = FBPunassignedConv;
	  document.getElementById("FBRopenConv").innerHTML = FBRopenConv;
	  document.getElementById("FBRassignedConv").innerHTML = FBRassignedConv;
	  document.getElementById("FBRunassignedConv").innerHTML = FBRunassignedConv;
	  document.getElementById("FBPNopenConv").innerHTML = FBPNopenConv;
	  document.getElementById("FBPNassignedConv").innerHTML = FBPNassignedConv;
	  document.getElementById("FBPNunassignedConv").innerHTML = FBPNunassignedConv;
	  document.getElementById("FBPNRopenConv").innerHTML = FBPNRopenConv;
	  document.getElementById("FBPNRassignedConv").innerHTML = FBPNRassignedConv;
	  document.getElementById("FBPNRunassignedConv").innerHTML = FBPNRunassignedConv;
	  document.getElementById("FIXopenConv").innerHTML = FIXopenConv;
	  document.getElementById("FIXassignedConv").innerHTML = FIXassignedConv;
	  document.getElementById("FIXunassignedConv").innerHTML = FIXunassignedConv;
	  document.getElementById("FIXRopenConv").innerHTML = FIXRopenConv;
	  document.getElementById("FIXRassignedConv").innerHTML = FIXRassignedConv;
	  document.getElementById("FIXRunassignedConv").innerHTML = FIXRunassignedConv;
	  document.getElementById("HopenConv").innerHTML = HopenConv;
	  document.getElementById("HassignedConv").innerHTML = HassignedConv;
	  document.getElementById("HunassignedConv").innerHTML = HunassignedConv;
	  document.getElementById("HRopenConv").innerHTML = HRopenConv;
	  document.getElementById("HRassignedConv").innerHTML = HRassignedConv;
	  document.getElementById("HRunassignedConv").innerHTML = HRunassignedConv;
	  document.getElementById("HNopenConv").innerHTML = HNopenConv;
	  document.getElementById("HNassignedConv").innerHTML = HNassignedConv;
	  document.getElementById("HNunassignedConv").innerHTML = HNunassignedConv;
	  document.getElementById("HNRopenConv").innerHTML = HNRopenConv;
	  document.getElementById("HNRassignedConv").innerHTML = HNRassignedConv;
	  document.getElementById("HNRunassignedConv").innerHTML = HNRunassignedConv;
	  document.getElementById("OopenConv").innerHTML = OopenConv;
	  document.getElementById("OassignedConv").innerHTML = OassignedConv;
	  document.getElementById("OunassignedConv").innerHTML = OunassignedConv;
	  document.getElementById("ORopenConv").innerHTML = ORopenConv;
	  document.getElementById("ORassignedConv").innerHTML = ORassignedConv;
	  document.getElementById("ORunassignedConv").innerHTML = ORunassignedConv;
	  document.getElementById("OFopenConv").innerHTML = OFopenConv;
	  document.getElementById("OFassignedConv").innerHTML = OFassignedConv;
	  document.getElementById("OFunassignedConv").innerHTML = OFunassignedConv;
	  document.getElementById("OFRopenConv").innerHTML = OFRopenConv;
	  document.getElementById("OFRassignedConv").innerHTML = OFRassignedConv;
	  document.getElementById("OFRunassignedConv").innerHTML = OFRunassignedConv;
	  document.getElementById("IopenConv").innerHTML = IopenConv;
	  document.getElementById("IassignedConv").innerHTML = IassignedConv;
	  document.getElementById("IunassignedConv").innerHTML = IunassignedConv;
	  document.getElementById("ICopenConv").innerHTML = ICopenConv;
	  document.getElementById("ICassignedConv").innerHTML = ICassignedConv;
	  document.getElementById("ICunassignedConv").innerHTML = ICunassignedConv;
	  document.getElementById("PopenConv").innerHTML = PopenConv;
	  document.getElementById("PassignedConv").innerHTML = PassignedConv;
	  document.getElementById("PunassignedConv").innerHTML = PunassignedConv;
	  document.getElementById("TFBopenConv").innerHTML = TFBopenConv;
	  document.getElementById("TFBassignedConv").innerHTML = TFBassignedConv;
	  document.getElementById("TFBunassignedConv").innerHTML = TFBunassignedConv;
	  document.getElementById("TWebopenConv").innerHTML = TWebopenConv;
	  document.getElementById("TWebassignedConv").innerHTML = TWebassignedConv;
	  document.getElementById("TWebunassignedConv").innerHTML = TWebunassignedConv;
	  document.getElementById("TOopenConv").innerHTML = TOopenConv;
	  document.getElementById("TOassignedConv").innerHTML = TOassignedConv;
	  document.getElementById("TOunassignedConv").innerHTML = TOunassignedConv;
	  document.getElementById("TOtheropenConv").innerHTML = TOtheropenConv;
	  document.getElementById("TOtherassignedConv").innerHTML = TOtherassignedConv;
	  document.getElementById("TOtherunassignedConv").innerHTML = TOtherunassignedConv;
	  
	  console.log("your logged agents: " + JSON.stringify(agentLogged));
	  console.log("your not-logged agents: " + JSON.stringify(agentAssigned));
	  
	  document.getElementById("offlineAssignedAgent").innerHTML = "Operatori offline che hanno conversazioni assegnate: " + agentAssigned;
	  document.getElementById("offlineAssignedAgent").style = "color : red";
	  
	  document.getElementById("unassignedConversationsList").innerHTML = unassignedConversationsList;
	  document.getElementById("unassignedConversationsList").style = "color : red";
	  
	  document.getElementById("assignedConversationsList").innerHTML = assignedConversationsList;
	  document.getElementById("assignedConversationsList").style = "color : green";
	  
	  
	  
	 
  }
	
  	
  
  function checklogin(accnumb, bearer){	
	$('#myloader').css('display', 'inline');
  	if(!((accnumb === null) || (accnumb === '') || (bearer === null) || (bearer === ''))){
    		$.ajax({
                    url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/msgHist/baseURI.lpCsds?version=1.0",
                    jsonp: "cb",
                    jsonpCallback: "domainCallback",
                    cache: true,
                    dataType: "jsonp",
                    success: function success(data) {
                        if('lpCallError' in data.ResultSet){
				localStorage.setItem('account_number', '');
			   	location.reload(); 
                        }
                        else{
                           	uri = data.ResultSet.lpData[0].lpServer;
				console.log(data);
                           	console.log(uri);
                           	$.ajax({
                              		url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=0&limit=50",
                              		method: "POST",
                              		jsonp: "cb",
                              		jsonpCallback: "domainCallback",
                              		cache: true,
                              		contentType: "application/json",
                              		data: '{\"start":{\"from\":' + (new Date().getTime()-5000) + ',\"to\":'+ new Date().getTime() + '}}',
                              		success: function success(data) {
						$('#myloader').css('display', 'none');
          					$('#myreports').css('display', 'inline');
						retrieveAgentsLogged();  // loads also the conversations
						setInterval(function(){
							loadBar();
						}, 30000);
						loadBar();
						loadSkills();
						loadTeams();
						refreshTranscripts();
						$('#loadedStats').css('display', 'none');
						$('#loadingStats').css('display', 'inline');	
                              		},
                              		error: function error(e, text) {
						localStorage.setItem('account_number', '');
				    		location.reload(); 
                              		},
                              		beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          	});   
                        }
                    },
                    error: function error(e, text) {
			    console.log(text);
			    localStorage.setItem('account_number', '');
			    location.reload(); 
                    }
              	});
  	  }
	  else{
		  $('#myloader').css('display', 'none');
		  $('#mylogin').css('display', 'inline');
	  }
  }
	
	
checklogin(accnumb, bearer);
	
	 
		
  
	
	
  $(document).on('click', function(evt) {
	  if($(evt.target).is('#logout')) {
		  $('#myreports').css('display', 'none');
		  $('#myloader').css('display', 'inline');
		  setTimeout(function(){
			  localStorage.setItem('account_number', '');
			  location.reload();
		  }, 2000);
	  }
	  if($(evt.target).is('#refresh')) {
		retrieveAgentsLogged();  // loads also the conversations
		  
		document.getElementById("loaderMSG").innerHTML = "Refreshing data!";
		document.getElementById("loaderMSG").style = "color : green";
		  
		$('#loadedStats').css('display', 'none');
		$('#loadingStats').css('display', 'inline');	
		  							
	  }
  });
		  	
  
  $(document).on('click', function(evt) {
	  if($("#accnumb").val() != ""){
		  if($(evt.target).is('#submitLogin')) {			  
			  uname = $("#uname").val();
			  localStorage.setItem('username', uname);
			  pwd = $("#pwd").val();
			  accnumb = $("#accnumb").val();
			  console.log(accnumb + " *** " + uname + " *** " + pwd);
			  $.ajax({
				  url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/agentVep/baseURI.lpCsds?version=1.0",
				  jsonp: "cb",
				  jsonpCallback: "domainCallback",
				  cache: true,
				  dataType: "jsonp",
				  success: function success(data) {
					  if('lpCallError' in data.ResultSet){
						  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
						  document.getElementById("sendStat").style = "color : red";
					  }
					  else{
						  uri = data.ResultSet.lpData[0].lpServer;
						  console.log(uri);
						  $.ajax({
							  url: "https://" + uri + "/api/account/" + accnumb + "/login?v=1.3",
							  method: "POST",
							  jsonp: "cb",
							  jsonpCallback: "domainCallback",
							  cache: true,
							  contentType: "application/json",
							  data: '{"username":"' + uname + '","password":"' + pwd +'"}',
							  success: function success(data) {
								  csrf = data.csrf;
								  bearer = data.bearer;
								  localStorage.setItem('account_number', accnumb);
								  localStorage.setItem('csrf', csrf);
								  localStorage.setItem('bearer', bearer);
								  $('#mylogin').css('display', 'none');
								  $('#myloader').css('display', 'inline');
								  setTimeout(function(){
									  $('#myloader').css('display', 'none');
									  $('#myreports').css('display', 'inline');
									  retrieveAgentsLogged();  // loads also the conversations
									  loadBar();
									  loadSkills();
									  loadTeams();
									  refreshTranscripts();
									  
									  $('#loadedStats').css('display', 'none');
									  $('#loadingStats').css('display', 'inline');  
									  
								  }, 2000);
							  },
							  error: function error(e, text) {
								  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
								  document.getElementById("sendStat").style = "color : red";
							  }
						  });
						  return data;
					  }
				  },
				  error: function error(e, text) {
					  console.log(text);
					  return e;
				  }
			  });
		  }
	  }
  });
    
  function refreshTranscripts(){
	  
	 var date = new Date();
	 var dd = date.getDate();
	 if (dd < 10){
		 dd = "0" + dd;
	 }
    	 var mm = date.getMonth() + 1;
	 if (mm < 10){
		 mm = "0" + mm;
	 }
    	 var y = date.getFullYear();
	 var enddate = y + "-" + mm + "-" + dd;
	 
	 date.setDate(date.getDate() - 7);
	 var dd = date.getDate();
	 if (dd < 10){
		 dd = "0" + dd;
	 }
    	 var mm = date.getMonth() + 1;
	 if (mm < 10){
		 mm = "0" + mm;
	 }
    	 var y = date.getFullYear();
	 var startdate = y + "-" + mm + "-" + dd;
	 
	 $('#startdate').val(startdate);
	 $('#starthour').val("00:00");
	 $('#enddate').val(enddate);
	 $('#endhour').val("23:59");
	 
	 
  		
	  
	 $(document).on('click', function(evt) {
		 
              if($(evt.target).is('.downloadTranscripts')) {
		
		      console.log($("#DropDownTimezone").val());
		      switch($("#DropDownTimezone").val()) {
    				case "(GMT +1:00 hour) Rome, Brussels, Copenhagen, Madrid, Paris":
        				timeZone = ":00 GMT+0100";
        			break;
    				case "(GMT +2:00) Kaliningrad, South Africa":
        				timeZone = ":00 GMT+0200";
        			break;
    				case "(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg":
        				timeZone = ":00 GMT+0300";
        			break;
				case "(GMT +3:30) Tehran":
        				timeZone = ":00 GMT+0330";
        			break;
    				case "(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi":
        				timeZone = ":00 GMT+0400";
        			break;
    				case "(GMT +4:30) Kabul":
        				timeZone = ":00 GMT+0430";
        			break;
    				case "(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent":
        				timeZone = ":00 GMT+0500";
        			break;
				case "(GMT +5:30) Bombay, Calcutta, Madras, New Delhi":
        				timeZone = ":00 GMT+0530";
        			break;
    				case "(GMT +6:00) Almaty, Dhaka, Colombo":
        				timeZone = ":00 GMT+0600";
        			break;
    				case "(GMT +7:00) Bangkok, Hanoi, Jakarta":
        				timeZone = ":00 GMT+0700";
        			break;
				case "(GMT +8:00) Beijing, Perth, Singapore, Hong Kong":
        				timeZone = ":00 GMT+0800";
        			break;
				case "(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk":
        				timeZone = ":00 GMT+0900";
        			break;
				case "(GMT +9:30) Adelaide, Darwin":
        				timeZone = ":00 GMT+0930";
        			break;
    				case "(GMT +10:00) Eastern Australia, Guam, Vladivostok":
        				timeZone = ":00 GMT+1000";
        			break;
    				case "(GMT +11:00) Magadan, Solomon Islands, New Caledonia":
        				timeZone = ":00 GMT+1100";
        			break;
    				case "(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka":
        				timeZone = ":00 GMT+1200";
        			break;
				case "(GMT -12:00) Eniwetok, Kwajalein":
        				timeZone = ":00 GMT-1200";
        			break;
    				case "(GMT -11:00) Midway Island, Samoa":
        				timeZone = ":00 GMT-1100";
        			break;
				case "(GMT -10:00) Hawaii":
        				timeZone = ":00 GMT-1000";
        			break;
    				case "(GMT -9:00) Alaska":
        				timeZone = ":00 GMT-0900";
        			break;
    				case "(GMT -8:00) Pacific Time (US &amp; Canada)":
        				timeZone = ":00 GMT-0800";
        			break;
    				case "(GMT -7:00) Mountain Time (US &amp; Canada)":
        				timeZone = ":00 GMT-0700";
        			break;
				case "(GMT -6:00) Central Time (US &amp; Canada), Mexico City":
        				timeZone = ":00 GMT-0600";
        			break;
				case "(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima":
        				timeZone = ":00 GMT-0500";
        			break;
				case "(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz":
        				timeZone = ":00 GMT-0400";
        			break;
    				case "(GMT -3:30) Newfoundland":
        				timeZone = ":00 GMT-0330";
        			break;
    				case "(GMT -3:00) Brazil, Buenos Aires, Georgetown":
        				timeZone = ":00 GMT-0300";
        			break;
    				case "(GMT -2:00) Mid-Atlantic":
        				timeZone = ":00 GMT-0200";
        			break;
				case "(GMT -1:00 hour) Azores, Cape Verde Islands":
        				timeZone = ":00 GMT-0100";
        			break;
				case "(GMT) Western Europe Time, London, Lisbon, Casablanca":
        				timeZone = ":00 GMT+0000";
        			break;
			}
		      
		      
		      
		     
		    startdate = $('#startdate').val();
		    startdate = new Date(startdate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = startdate.getFullYear();
  		    var month = months[startdate.getMonth()];
  	            var date = startdate.getDate(); 
		    var hour = $('#starthour').val();
		    startdate = month + " " + date + " " + year + " " + hour + timeZone;
		    var d = new Date(startdate);
		    var start = d.getTime();
		      
		    
		    enddate = $('#enddate').val();
		    enddate = new Date(enddate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = enddate.getFullYear();
  		    var month = months[enddate.getMonth()];
  	            var date = enddate.getDate(); 
		    var hour = $('#endhour').val();
		    enddate = month + " " + date + " " + year + " " + hour + timeZone;
		    var d = new Date(enddate);
		    var end = d.getTime();  
		    var options = $('#transcriptOptions').val();
		      
		    if (start >= end) { 
			    document.getElementById("reportMSG").innerHTML = "Please insert a correct end date!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else if (((end - start)/1000) > (60*60*24*30)){
			    document.getElementById("reportMSG").innerHTML = "No more than 30 days!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else{
			    document.getElementById("reportMSG").innerHTML = "";
			    downloadTranscripts(start, end, options);
		    }
		      
		      
		    
              }
	 });
	  
	  
  }
    
 
 function loadConvs(){
	 
	 
	 
	 var end = Date.now();
	 var start = end - (1000*60*60*24*30);  // loading Convs started till 30 days ago
	 var offset = 0;
	 var body = "";
	 var answer = [];
	 if(skillNumber === "-1"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '}, "status": ["OPEN"]';
	 }
	 else{
		 body = '{"start":{"from":' + start + ',"to":' + end + '}, "status": ["OPEN"], "skillIds": ["' + skillNumber + overwriteHumanSkill + '"]';
		 console.log(body);
	 }
	 if (teamNumber){
		 body = body + ' ,"agentGroupIds":["' + teamNumber + '"]}';
	 }
	 else{
		 body = body + '}';
	 }
	 
	 console.log(body);
	 console.log("(HISTORICAL) skill: " + skillNumber + " ***** team: " + teamNumber + " ***** start: " + start + " ***** end: " + end);
	 function loadClosedConvs(body, offset, callback) {
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100&sort=start:desc",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      if((data.conversationHistoryRecords.length) == 100){
					      offset = offset + 100;
					      answer = answer.concat(data.conversationHistoryRecords);
					      document.getElementById("loaderMSG").innerHTML = "...downloading sessions:" + Math.round(100*(offset/data._metadata.count)) + "% completed...";
					      document.getElementById("loaderMSG").style = "color : green";
					      console.log ("adding conversations...");
					      loadClosedConvs(body, offset, callback);
				      }
				      else{
					      console.log(answer.length);
					      answer = answer.concat(data.conversationHistoryRecords);
					      console.log(answer.length);
					      loadStats(answer);
				      }
				      
     
				      
                              },
                              error: function error(e, text) {
				      location.reload();
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 
	 function loadOpenConvs(body, offset, callback) {
		 
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      if((data.conversationHistoryRecords.length) == 100){
					      offset = offset + 100;
					      answer = answer.concat(data.conversationHistoryRecords);
					      document.getElementById("loaderMSG").innerHTML = "...downloading open sessions:" + Math.round(100*(offset/data._metadata.count)) + "% completed...";
					      document.getElementById("loaderMSG").style = "color : green";
					      console.log ("adding conversations...");
					      loadOpenConvs(body, offset, callback);   
				      }
				      else{
					      
					      /****************
					      answer = answer.concat(data.conversationHistoryRecords);
					      offset = 0;
					      if(skillNumber === "-1"){
						     body = '{"start":{"from":' + start + ',"to":' + end + '}, "status": ["CLOSE"]';
					      }
					      else{
						       body = '{"start":{"from":' + start + ',"to":' + end + '}, "status": ["CLOSE"], "skillIds": ["' + skillNumber + overwriteHumanSkill + '"]';
						      console.log(body);
					      }
					      if(teamNumber){
						      body = body + ' ,"agentGroupIds":["' + teamNumber + '"]}';
					      }
					      else{
						      body = body + '}';
					      }
					      console.log(body);
					      loadClosedConvs(body, offset, callback);
					      ******************/
					      
					      // console.log(answer.length);
					      answer = answer.concat(data.conversationHistoryRecords);
					      console.log(answer.length);
					      loadStats(answer);
				      }
				      
     
				      
                              },
                              error: function error(e, text) {
				      location.reload();
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 
	 
	 setTimeout(function(){
	 	loadOpenConvs(body, offset, function(err, resp) {
		 	// Your code here...
	 	});
	 }, 3000);
	 
 }
	
	
	 function exportData(){
		 download = function (content, filename, contentType) {
    			var a = document.getElementById('hiddenbutton');
    			var blob = new Blob([content], {
        			'type': contentType
    			});
    			a.href = window.URL.createObjectURL(blob);
    			a.download = filename;
			$("#downloadTranscripts").prop( "disabled", false ); 
		};
		download(myFileToXLS, 'transcripts.xls', 'application/vnd.ms-excel');
		$("#hiddenbutton")[0].click();
		
			 
	 }
	
	function analysis(answer, proceed) {
		var totalLength = answer.length;
		for (var i = 0; i < totalLength; i++){
			setTimeout(function(i) {
				
		
							var messages = "";
							var thismessage = "";
							var thisactor = "";
							var endReason = "";
							var length = answer[i].messageRecords.length;
							for (var m = 0; m < length; m++){
							      var type = answer[i].messageRecords[m].type;
							      if(type === "TEXT_PLAIN"){
								   thismessage = answer[i].messageRecords[m].messageData.msg.text;
								   // thismessage = thismessage.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/, '**emoticon**');
								   // thismessage = thismessage.replace(/www./, '**link**');
								   // thismessage = thismessage.replace(/http/, '**link**');
								   thismessage = thismessage.replace(/[&\/\\#+$~%<>{}\n\r]/g,'%d');
							      }
							      else{
								   thismessage = "-structured content-";
							      }
							      thisactor = answer[i].messageRecords[m].sentBy;
							      messages = messages + "     " + thisactor + ": " + thismessage;
						      }
						      if(answer[i].info.endTimeL === -1){
							      endReason = "IN_PROGRESS";
						      }
						      else{
							      if(answer[i].info.latestSkillName === "Limbo"){
								      endReason = "AUTO_CLOSURE";
      
							      }else{
								      endReason = answer[i].info.closeReason;
							      }
						      }
						      
						      
						      
						      
						      var TimeAnswer = 0;
						      var whatTime = 0;
						      var firstTimeAnswer = "";
						      var isAnswered = 0;
						      var lastMessageAgent = 0;
						      var howManyMessages = answer[i].messageRecords.length;
						      if(howManyMessages){
							      for (var nh = (howManyMessages-1); nh >= 0; nh--){
								      if ((answer[i].messageRecords[nh].sentBy === "Agent") && (answer[i].messageRecords[nh].participantId !== "1089636032")){
									      lastMessageAgent = answer[i].messageRecords[nh].timeL;
									      nh = 0;
								      }
							      }
							      if (answer[i].messageRecords[0].sentBy === "Consumer"){
								      whatTime = answer[i].messageRecords[0].timeL;
								      isAnswered = 0;
								      for (var n = 1; n < howManyMessages; n++){
									      if(answer[i].messageRecords[n].sentBy === "Agent" && answer[i].messageRecords[n].participantId !== FacebookBotID){
										      TimeAnswer = (answer[i].messageRecords[n].timeL - whatTime)/1000;
										      isAnswered = 1;
										      n = howManyMessages;
									      }
								      }
								      
								      if (isAnswered){
									      firstTimeAnswer = Math.floor(parseInt(TimeAnswer));
								      }
								      else{
									      firstTimeAnswer = "NOT_ANSWERED"
								      }
							      }
						      }
						      var phoneNumber = "-";
						      var imeiNumber = "-";
						      var customerName = "";
						      var channel = "FaceBook";
						      var valueDoingRouting = "";
						      var myTimeStampRouting = 0;
						      if(answer[i].hasOwnProperty('sdes')){
							      var myLengthSdes = answer[i].sdes.events.length;
							      for (var xs = 0; xs < myLengthSdes; xs++){
								      if(answer[i].sdes.events[xs].hasOwnProperty('customerInfo')){
									      
									      imeiNumber = answer[i].sdes.events[xs].customerInfo.customerInfo.imei;
									      if(answer[i].sdes.events[xs].customerInfo.customerInfo.hasOwnProperty('customerType')){
										      if(myTimeStampRouting < answer[i].sdes.events[xs].customerInfo.serverTimeStamp){
											      myTimeStampRouting = answer[i].sdes.events[xs].customerInfo.serverTimeStamp;
											      valueDoingRouting = answer[i].sdes.events[xs].customerInfo.customerInfo.customerType;
											      if((valueDoingRouting.indexOf("uman") > -1) || (valueDoingRouting.indexOf("VIP") > -1) || (valueDoingRouting.indexOf("skill_notturna_mobile") > -1) || (valueDoingRouting.indexOf("app_fixed") > -1)){
												      channel = "Web";
											      } else{
												      channel = "FaceBook";
											      }
											      
										      
										      }
									      }
								      }
							      }
							      
							      if(answer[i].sdes.events[0].hasOwnProperty('personalInfo')){
								      if(answer[i].sdes.events[0].personalInfo.personalInfo.contacts.length){
									      phoneNumber = answer[i].sdes.events[0].personalInfo.personalInfo.contacts[0].personalContact.phone;
									      if(answer[i].sdes.events[0].personalInfo.personalInfo.hasOwnProperty('name')){
										      var sdesName = answer[i].sdes.events[0].personalInfo.personalInfo.name;
									      }
									      else{
										      var sdesName = "";
									      }
									      if(answer[i].sdes.events[0].personalInfo.personalInfo.hasOwnProperty('surname')){
										      var sdesSurname = answer[i].sdes.events[0].personalInfo.personalInfo.surname;
									      }
									      else{
										      var sdesSurname = "";
									      }
									      customerName = sdesName + " " + sdesSurname;
								      }
							      }
							      
							      
							      /*****************/
							      
							   
							      var timestampFacebook_priv;
							      var timestampOutbound = 0;
							      var timestampNight = 0;
							      var timeSpentInFacebook_bot = 0;
							      var startingTime = 0;
							      var timeToAcceptFacebook = 0;
							      var isAccepted = false;
							      var firstTimeAnswerFacebook =  "-";
							      var participantID = 0;
							      var controlOB = 0;
							      var night = "No";
							      var campo1 = "";
							      var campo2 = "";
							      if(answer[i].hasOwnProperty('transfers')){
								      if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 0) {
									      campo2 = answer[i].transfers[0].sourceSkillName;
								      }else{
									      campo2 = answer[i].info.latestSkillName;
								      }
							      } else{
								      campo2 = answer[i].info.latestSkillName;
							      }
							      
							      
							       if(answer[i].hasOwnProperty('transfers')){
								       if(answer[i].transfers.length > 0){
									       if(answer[i].transfers[0].targetSkillName.indexOf("bot") > -1){
										       if(answer[i].transfers.length > 2){
											       if(answer[i].transfers[2].targetSkillName.indexOf("ight") > -1){
												       night = "Yes";
											       }
										       } else{
											       night = "Undefined";
										       }
									       } else{
										       if(answer[i].transfers[0].targetSkillName.indexOf("ight") > -1){
											       night = "Yes";
										       }
									       }
								       } else{
									       if(answer[i].info.latestSkillName.indexOf("ight") > -1){
										       night = "Yes";
									       }
								       }
							       } else{
								       if(answer[i].info.latestSkillName.indexOf("ight") > -1){
									       night = "Yes";
								       }
							       }
											       
							     
							      
							      if(valueDoingRouting.indexOf("ight") > -1){
								      night = "Yes";
							      }
							      if(valueDoingRouting.indexOf("notturna") > -1){
								      night = "Yes";
							      }
							      if(answer[i].hasOwnProperty('transfers')){
								      if(answer[i].transfers.length == 0){
									      if(answer[i].info.latestSkillName.indexOf("ight") > -1){
										      night = "Yes";
									      }
								      }
								      if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 2) {
									      if(answer[i].transfers[2].targetSkillName.indexOf("ight") > -1){
										      night = "Yes";
									      }
								      }
							      }
							      if((channel === "FaceBook") || (channel === "Web")){
								      startingTime = answer[i].info.startTimeL;
								      if(answer[i].hasOwnProperty('transfers')){
									      if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 0) {
										      var arraylength = answer[i].transfers.length;
										      
										      for (var p = 0; p < arraylength; p++){
											     if(answer[i].transfers[p].targetSkillName.indexOf("utbound") > -1){
												     timestampOutbound = new Date(answer[i].transfers[p].timeL);
												     p = arraylength;
												     controlOB = 1;
											     }
										      }
										      if(controlOB === 0){
											      timestampOutbound = "-";
										      }
									      }
								      }
								      
								      if(channel === "FaceBook"){
									      if(answer[i].hasOwnProperty('sdes')){
										      if(answer[i].sdes.hasOwnProperty('events')){
											      var searchCustomerInfo = answer[i].sdes.events.length;
											      for (var wq = 0; wq  < searchCustomerInfo; wq ++){
												      if(answer[i].sdes.events[wq].hasOwnProperty('customerInfo')){
													      if(answer[i].sdes.events[wq].customerInfo.hasOwnProperty('customerId')){
														      if(answer[i].sdes.events[wq].customerInfo.customerInfo.customerId.indexOf("_") > -1){
															      campo1 = answer[i].sdes.events[wq].customerInfo.customerInfo.customerId.replace('facebook_13099967_','');
														      } else{
															      campo1 = answer[i].sdes.events[wq].customerInfo.customerInfo.customerId;
														      }
														      wq = searchCustomerInfo;
														      campo1 = campo1.toString();
													      }
												      }
											      }
										      }
									      }
									      if(answer[i].hasOwnProperty('agentParticipants') && answer[i].agentParticipants.length){
										      for (var b = 0; b < answer[i].agentParticipants.length; b++){
											      if((answer[i].agentParticipants[b].userTypeName === "Human") && (answer[i].agentParticipants[b].permission === "ASSIGNED_AGENT")){
												      isAccepted = true;
												      participantID = answer[i].agentParticipants[b].agentId;
												      timeToAcceptFacebook = Math.floor((answer[i].agentParticipants[b].timeL - startingTime)/1000);
												      b = answer[i].agentParticipants.length;
											      }
										      }
									      }
									      timeSpentInFacebook_bot = "-";
									      if(!isAccepted){
										      timeToAcceptFacebook = "NOT ACCEPTED";
										      firstTimeAnswerFacebook = "-";
										      timestampFacebook_priv = "-";
									      } else{
										      timeToAcceptFacebook = timeToAcceptFacebook.toString();
										      firstTimeAnswerFacebook = firstTimeAnswer.toString();
										      timestampFacebook_priv = new Date(startingTime);
									      }
									      
								      }
							      
							      	      if(channel === "Web"){
									      if(answer[i].hasOwnProperty('agentParticipants') && answer[i].agentParticipants.length){
										      for (var b = 0; b < answer[i].agentParticipants.length; b++){
											      if((answer[i].agentParticipants[b].userTypeName === "Human") && (answer[i].agentParticipants[b].permission === "ASSIGNED_AGENT")){
												      isAccepted = true;
												      participantID = answer[i].agentParticipants[b].agentId;
												      timeToAcceptFacebook = Math.floor((answer[i].agentParticipants[b].timeL - answer[i].info.startTimeL)/1000);
												      b = answer[i].agentParticipants.length;
											      }
										      }
									      }
									      
									      timeSpentInFacebook_bot = "-";
									      if(!isAccepted){
										      timeToAcceptFacebook = "NOT ACCEPTED";
										      firstTimeAnswerFacebook = "-";
										      timestampFacebook_priv = "-";
									      } else{
										      timeToAcceptFacebook = timeToAcceptFacebook.toString();
										      firstTimeAnswerFacebook = firstTimeAnswer.toString();
										      timestampFacebook_priv = new Date(startingTime);
									      }
								      }
							      }
							      
							      
							      if(answer[i].sdes.events[1].hasOwnProperty('personalInfo')){
								      if(answer[i].sdes.events[1].personalInfo.personalInfo.contacts.length){
									      phoneNumber = answer[i].sdes.events[1].personalInfo.personalInfo.contacts[0].personalContact.phone;
									      if(answer[i].sdes.events[1].personalInfo.personalInfo.hasOwnProperty('name')){
										      var sdesName = answer[i].sdes.events[1].personalInfo.personalInfo.name;
									      }
									      else{
										      var sdesName = "";
									      }
									      if(answer[i].sdes.events[1].personalInfo.personalInfo.hasOwnProperty('surname')){
										      var sdesSurname = answer[i].sdes.events[1].personalInfo.personalInfo.surname;
									      }
									      else{
										      var sdesSurname = "";
									      }
									      customerName = sdesName + " " + sdesSurname;
								      }
							      }
						      }
						      
						      var yesno = "-";
						      var comments = "-";
						      var facebook_out = "No";
						      if(answer[i].hasOwnProperty('transfers')){
							      if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 0) {
								      var arraylength = answer[i].transfers.length;
								      for (var z = 0; z < arraylength; z++){
									      if((answer[i].transfers[z].targetSkillName.indexOf("utbound")) > -1){
										      facebook_out = "Yes";
									      }
								      }
								      for (var z = (arraylength -1); z > -1; z--){
									      if(answer[i].transfers[z].hasOwnProperty('contextData')){
										      if(answer[i].transfers[z].contextData.hasOwnProperty('structuredMetadata')){
											      if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "yesno"){
												      yesno = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].name;
												      if (yesno !== undefined || yesno !== "---"){
													      comments = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[1].name;
													      z = 0;
												      }
											      }
											      
										      }
									      }
								      }
							      }
						      }
						      if(yesno === undefined || yesno ==="-"){
							      yesno = "---";
						      }
						      var skill = answer[i].info.latestSkillName;
						      var limbo = 0;
						      var freeze = 0;
						      var risvegliata = 0;
						      var risvegliataFreeze = 0;
						      var risvegliataOutbound = 0;
						      var risvegliataGeneral = 0;
						      var risvegliataFreezeOutbound = 0;
						      var risvegliataFreezeGeneral = 0;
						      var limboOutbound = 0;
						      var limboGeneral = 0;
						      var freezeOutbound = 0;
						      var freezeGeneral = 0;
						      var isRisvegliataOutbound = false;
						      var limboaveragetime = 0;
						      var wasInLimbo = 0;
						      var startLimbo = 0;
						      var totalLimbo = 0;
						      var numero_telefono = "---";
						      var numero_ricontatto = "---";
						      var numero_cfiscale = "---";
						      var vfTag = "---";
						      var triplettauno = "---";
						      var triplettadue = "---";
						      var triplettatre = "---";
						      var lastTagFromAgent = 0;
						      if(answer[i].hasOwnProperty('transfers')){
							      if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 0) {
								      
								      var arraylength = answer[i].transfers.length;
								      for (var z = (arraylength -1); z > -1; z--){
									      if(answer[i].transfers[z].hasOwnProperty('contextData')){
										      if(answer[i].transfers[z].contextData.hasOwnProperty('structuredMetadata')){
											      if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "telefono"){
												      lastTagFromAgent = answer[i].transfers[z].timeL;
												      numero_telefono = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].name;
												      numero_ricontatto = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[1].name;
												      numero_cfiscale = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[2].name;
												      vfTag = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[3].name;
												      triplettauno = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[4].name;
												      triplettadue = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[5].name;
												      triplettatre = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[6].name;
												      if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents.length > 7){
													   yesno = answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[7].name;
												      }
												      if(vfTag === "undefined"){
													      vfTag = "---";
												      }
												      if(triplettauno === "undefined"){
													     triplettauno = "---"; 
												      }
												      if(triplettadue === "undefined"){
													     triplettadue = "---"; 
												      }
												      if(triplettatre === "undefined"){
													     triplettatre = "---"; 
												      }
												      z = 0;
											      }
										      }
									      }
								      }
   
								      for (var z = 0; z < arraylength; z++){
									      if (answer[i].transfers[z].targetSkillName.indexOf("utbound") > -1){
										      isRisvegliataOutbound = true;
									      } else if (answer[i].transfers[z].targetSkillName.indexOf("acebook") > -1){
										      isRisvegliataOutbound = false;
									      } else if (answer[i].transfers[z].targetSkillName.indexOf("uman") > -1){
										      isRisvegliataOutbound = false;
									      } else if (answer[i].transfers[z].targetSkillName.indexOf("Fixed") > -1){
										      isRisvegliataOutbound = false;
									      }
									      if ((answer[i].transfers[z].targetSkillName === "Limbo") && (answer[i].transfers[z].sourceSkillName !== "Limbo")){
										      limbo = limbo +1;
										      if (isRisvegliataOutbound){
											      limboOutbound = limboOutbound + 1;
										      } else{
											      limboGeneral = limboGeneral + 1;
										      }
										      wasInLimbo = 1;
										      startLimbo = answer[i].transfers[z].timeL;
									      }
									      if ((answer[i].transfers[z].targetSkillName === "Freeze") && (answer[i].transfers[z].sourceSkillName !== "Freeze")){
										      freeze = freeze +1;
										      if (isRisvegliataOutbound){
											      freezeOutbound = freezeOutbound + 1;
										      } else{
											      freezeGeneral = freezeGeneral + 1;
										      }
									      }
									      if ((answer[i].transfers[z].targetSkillName !== "Limbo") && (answer[i].transfers[z].sourceSkillName === "Limbo")){
										      risvegliata = risvegliata +1;
										      if (isRisvegliataOutbound){
											      risvegliataOutbound = risvegliataOutbound + 1;
										      } else{
											      risvegliataGeneral = risvegliataGeneral + 1;
										      }
										      totalLimbo = totalLimbo + ((answer[i].transfers[z].timeL - startLimbo)/1000);
									      }
									      if ((answer[i].transfers[z].targetSkillName !== "Freeze") && (answer[i].transfers[z].sourceSkillName === "Freeze")){
										      risvegliataFreeze = risvegliataFreeze +1;
										      if (isRisvegliataOutbound){
											      risvegliataFreezeOutbound = risvegliataFreezeOutbound + 1;
										      } else{
											      risvegliataFreezeGeneral = risvegliataFreezeGeneral + 1;
										      }
									      }
								      }
							      }
						      }
				
							if(answer[i].hasOwnProperty('agentParticipants')){
								if (typeof answer[i].agentParticipants !== 'undefined' && answer[i].agentParticipants.length > 0) {
									var arraylength = answer[i].agentParticipants.length;
									for (var z = (arraylength -1); z > -1; z--){
										if(answer[i].agentParticipants[z].hasOwnProperty('contextData')){
										      if(answer[i].agentParticipants[z].contextData.hasOwnProperty('structuredMetadata')){
											      if(answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "telefono"){
												      lastTagFromAgent = answer[i].agentParticipants[z].timeL;
												      numero_telefono = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[0].name;
												      numero_ricontatto = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[1].name;
												      numero_cfiscale = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[2].name;
												      vfTag = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[3].name;
												      triplettauno = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[4].name;
												      triplettadue = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[5].name;
												      triplettatre = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[6].name;
												      if(answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents.length > 7){
													    yesno = answer[i].agentParticipants[z].contextData.structuredMetadata[0].botResponse.intents[7].name;
												      }
												      if(vfTag === "undefined"){
													      vfTag = "---";
												      }
												      if(triplettauno === "undefined"){
													     triplettauno = "---"; 
												      }
												      if(triplettadue === "undefined"){
													     triplettadue = "---"; 
												      }
												      if(triplettatre === "undefined"){
													     triplettatre = "---"; 
												      }
												      z = 0;
											      }
										      }
									      }
									}
								}
							}
				
				
						      if(wasInLimbo == 1){
							      if (totalLimbo > 0){
								     limboaveragetime = Math.floor(totalLimbo/limbo); 
							      }
							      else{
								     limboaveragetime = "non svegliata"; 
							      }
						      }
						      else{
							      limboaveragetime = "niente Limbo";
						      }
						      
						      var timeToAccept = 0;
						      TimeAnswer = 0;
						      whatTime = 0;
						      isAnswered = 0;
						      
						      
						      var effortTimeGeneral = 0;
						      var effortTimeOutbound = 0;
						      var lastAgentGeneral = "";
						      var lastAgentOutbound = "";
						      var lastTeamGeneral = "";
						      var lastTeamOutbound = "";
						      var lastProperTeamGeneral = "";
						      var lastProperTeamOutbound = "";
						      
						      var numberAgentsGeneral = 0;
						      var numberAgentsOutbound = 0;
						      var numberTeamsGeneral = 0;
						      var numberTeamsOutbound = 0;
						      
						      var arrayAgentsGeneral = [];
						      var arrayAgentsOutbound = [];
						      var arrayTeamsGeneral = [];
						      var arrayTeamsOutbound = [];
						      var arrayProperTeamsGeneral = [];
						      var arrayProperTeamsOutbound = [];
						      howManyMessages = answer[i].messageRecords.length;
						      var partialTime = 0;
						      if(howManyMessages){
								      
						      		if(answer[i].hasOwnProperty('agentParticipants') && answer[i].agentParticipants.length){
									if(answer[i].hasOwnProperty('transfers')){
										var agentParticipantsLength = answer[i].agentParticipants.length;
										var transferLength = answer[i].transfers.length;
										var isGeneral = 0;
										var isOutbound = 0;
										var agentLoginName = "";
										var agentSkill = "";
										var sourceSkillName = "";
										var jumpInTimestamp = 0;
										
										for (var f = 0; f < transferLength; f++){
											if(answer[i].transfers[f].sourceSkillName.indexOf("bound") > -1){
												isGeneral = 0;
												isOutbound = 1;
												f = transferLength;
											} else if((answer[i].transfers[f].sourceSkillName.indexOf("acebook") > -1) || (answer[i].transfers[f].sourceSkillName.indexOf("uman") > -1) || (answer[i].transfers[f].sourceSkillName.indexOf("Fixed") > -1)){
												isGeneral = 1;
												isOutbound = 0;
												f = transferLength;
											}
										}
												
										for (var z = 0; z < agentParticipantsLength; z++){
											if((answer[i].agentParticipants[z].userTypeName === "Human") && (answer[i].agentParticipants[z].permission === "ASSIGNED_AGENT")){
												agentLoginName = answer[i].agentParticipants[z].agentLoginName;
												jumpInTimestamp = answer[i].agentParticipants[z].timeL;
												if(transferLength === 0){
													if(answer[i].info.endTimeL === -1){
														effortTimeGeneral = (Date.now() - jumpInTimestamp)/1000;
													} else{
														effortTimeGeneral = (answer[i].info.endTimeL - jumpInTimestamp)/1000;
													}
													
													lastAgentGeneral = answer[i].agentParticipants[z].agentFullName;
													lastTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
													lastProperTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
													if(!arrayProperTeamsGeneral.includes(lastTeamGeneral)){
														arrayProperTeamsGeneral.push(lastTeamGeneral);
													}
													if(!arrayAgentsGeneral.includes(lastAgentGeneral)){
														arrayAgentsGeneral.push(lastAgentGeneral);
													}
													var agentAlberoLength = alberoArray.length;
													for(var counter = 0; counter < agentAlberoLength; counter++){
														if (alberoArray[counter].son === lastTeamGeneral){
															lastTeamGeneral = alberoArray[counter].father;
															counter = agentAlberoLength;
														}
													}
													if(!arrayTeamsGeneral.includes(lastTeamGeneral)){
														arrayTeamsGeneral.push(lastTeamGeneral);
													}
													z = agentParticipantsLength;
												}
												for (var f = 0; f < transferLength; f++){
													if(answer[i].transfers[f].timeL > jumpInTimestamp){
														if(answer[i].transfers[f].targetSkillName === "Limbo" || answer[i].transfers[f].targetSkillName === "Freeze" ){
															partialTime = (answer[i].transfers[f].timeL - jumpInTimestamp)/1000;
															if(isGeneral){
																effortTimeGeneral = effortTimeGeneral + partialTime;
																lastAgentGeneral = answer[i].agentParticipants[z].agentFullName;
																lastTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
																lastProperTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
																if(!arrayProperTeamsGeneral.includes(lastTeamGeneral)){
																	arrayProperTeamsGeneral.push(lastTeamGeneral);
																}
																if(!arrayAgentsGeneral.includes(lastAgentGeneral)){
																	arrayAgentsGeneral.push(lastAgentGeneral);
																}
																var agentAlberoLength = alberoArray.length;
																for(var counter = 0; counter < agentAlberoLength; counter++){
																	if (alberoArray[counter].son === lastTeamGeneral){
																		lastTeamGeneral = alberoArray[counter].father;
																		counter = agentAlberoLength;
																	}
																}
																if(!arrayTeamsGeneral.includes(lastTeamGeneral)){
																	arrayTeamsGeneral.push(lastTeamGeneral);
																}
															}
															if(isOutbound){
																effortTimeOutbound = effortTimeOutbound + partialTime;
																lastAgentOutbound = answer[i].agentParticipants[z].agentFullName;
																lastTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
																lastProperTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
																if(!arrayProperTeamsOutbound.includes(lastTeamOutbound)){
																	arrayProperTeamsOutbound.push(lastTeamOutbound);
																}
																if(!arrayAgentsOutbound.includes(lastAgentOutbound)){
																	arrayAgentsOutbound.push(lastAgentOutbound);
																}
																var agentAlberoLength = alberoArray.length;
																for(var counter = 0; counter < agentAlberoLength; counter++){
																	if (alberoArray[counter].son === lastTeamOutbound){
																		lastTeamOutbound = alberoArray[counter].father;
																		counter = agentAlberoLength;
																	}
																}
																if(!arrayTeamsOutbound.includes(lastTeamOutbound)){
																	arrayTeamsOutbound.push(lastTeamOutbound);
																}
															}
															f = transferLength;
														}
														else if((answer[i].transfers[f].targetSkillName.indexOf("acebook") > -1) || (answer[i].transfers[f].targetSkillName.indexOf("uman") > -1) || (answer[i].transfers[f].targetSkillName.indexOf("Fixed") > -1)){
															
															if(isOutbound){
																isGeneral = 1;
																isOutbound = 0;
																partialTime = (answer[i].transfers[f].timeL - jumpInTimestamp)/1000;
																effortTimeOutbound = effortTimeOutbound + partialTime;
																lastAgentOutbound = answer[i].agentParticipants[z].agentFullName;
																lastTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
																lastProperTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
																if(!arrayProperTeamsOutbound.includes(lastTeamOutbound)){
																	arrayProperTeamsOutbound.push(lastTeamOutbound);
																}
																if(!arrayAgentsOutbound.includes(lastAgentOutbound)){
																	arrayAgentsOutbound.push(lastAgentOutbound);
																}
																var agentAlberoLength = alberoArray.length;
																for(var counter = 0; counter < agentAlberoLength; counter++){
																	if (alberoArray[counter].son === lastTeamOutbound){
																		lastTeamOutbound = alberoArray[counter].father;
																		counter = agentAlberoLength;
																	}
																}
																if(!arrayTeamsOutbound.includes(lastTeamOutbound)){
																	arrayTeamsOutbound.push(lastTeamOutbound);
																}
																f = transferLength;
															}
														}
														else if(answer[i].transfers[f].targetSkillName.indexOf("utbound") > -1){
															
															if(isGeneral){
																isGeneral = 0;
																isOutbound = 1;
																partialTime = (answer[i].transfers[f].timeL - jumpInTimestamp)/1000;
																effortTimeGeneral = effortTimeGeneral + partialTime;
																lastAgentGeneral = answer[i].agentParticipants[z].agentFullName;
																lastTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
																lastProperTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
																if(!arrayProperTeamsGeneral.includes(lastTeamGeneral)){
																	arrayProperTeamsGeneral.push(lastTeamGeneral);
																}
																
																if(!arrayAgentsGeneral.includes(lastAgentGeneral)){
																	arrayAgentsGeneral.push(lastAgentGeneral);
																}
																var agentAlberoLength = alberoArray.length;
																for(var counter = 0; counter < agentAlberoLength; counter++){
																	if (alberoArray[counter].son === lastTeamGeneral){
																		lastTeamGeneral = alberoArray[counter].father;
																		counter = agentAlberoLength;
																	}
																}
																if(!arrayTeamsGeneral.includes(lastTeamGeneral)){
																	arrayTeamsGeneral.push(lastTeamGeneral);
																}
																f = transferLength;
															}
															
															
															
														}
													}
													if (f === (transferLength - 1)){
														if(answer[i].info.endTimeL > 0){
															partialTime = (answer[i].info.endTimeL - jumpInTimestamp)/1000;
														}
														
														if(isGeneral){
															effortTimeGeneral = effortTimeGeneral + partialTime;
															lastAgentGeneral = answer[i].agentParticipants[z].agentFullName;
															lastTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
															lastProperTeamGeneral = answer[i].agentParticipants[z].agentGroupName;
															if(!arrayProperTeamsGeneral.includes(lastTeamGeneral)){
																arrayProperTeamsGeneral.push(lastTeamGeneral);
															}
															if(!arrayAgentsGeneral.includes(lastAgentGeneral)){
																arrayAgentsGeneral.push(lastAgentGeneral);
															}
															var agentAlberoLength = alberoArray.length;
															for(var counter = 0; counter < agentAlberoLength; counter++){
																if (alberoArray[counter].son === lastTeamGeneral){
																	lastTeamGeneral = alberoArray[counter].father;
																	counter = agentAlberoLength;
																}
															}
															if(!arrayTeamsGeneral.includes(lastTeamGeneral)){
																arrayTeamsGeneral.push(lastTeamGeneral);
															}
														}
														if(isOutbound){
															effortTimeOutbound = effortTimeOutbound + partialTime;
															lastAgentOutbound = answer[i].agentParticipants[z].agentFullName;
															lastTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
															lastProperTeamOutbound = answer[i].agentParticipants[z].agentGroupName;
															if(!arrayProperTeamsOutbound.includes(lastTeamOutbound)){
																arrayProperTeamsOutbound.push(lastTeamOutbound);
															}
															if(!arrayAgentsOutbound.includes(lastAgentOutbound)){
																arrayAgentsOutbound.push(lastAgentOutbound);
															}
															var agentAlberoLength = alberoArray.length;
															for(var counter = 0; counter < agentAlberoLength; counter++){
																if (alberoArray[counter].son === lastTeamOutbound){
																	lastTeamOutbound = alberoArray[counter].father;
																	counter = agentAlberoLength;
																}
															}
															if(!arrayTeamsOutbound.includes(lastTeamOutbound)){
																arrayTeamsOutbound.push(lastTeamOutbound);
															}
														}
															
														
													}
												}
											}
										}
									}
								}
							}
							effortTimeGeneral = Math.floor(effortTimeGeneral);
						        effortTimeOutbound = Math.floor(effortTimeOutbound);
							// console.log("effortTimeGeneral: " + effortTimeGeneral + " ******** effortTimeOutbound: " + effortTimeOutbound);
						        // console.log("convID: " + answer[i].info.conversationId);
						      	numberAgentsGeneral = arrayAgentsGeneral.length;
						        numberAgentsOutbound = arrayAgentsOutbound.length;
						        numberTeamsGeneral = arrayTeamsGeneral.length;
						        numberTeamsOutbound = arrayTeamsOutbound.length;
						      
								      
						      
							timestampOutbound = "-";
						      	if(answer[i].hasOwnProperty('transfers')){
								if (typeof answer[i].transfers !== 'undefined' && answer[i].transfers.length > 0) {
									var arraylength = answer[i].transfers.length;
									for (var p = 0; p < arraylength; p++){
										if(answer[i].transfers[p].targetSkillName.indexOf("utbound") > -1){
											timestampOutbound = new Date(answer[i].transfers[p].timeL);
											p = arraylength;
										}
									}
								}
							}
									      
										      
						      
						      howManyMessages = answer[i].messageRecords.length;
						      if(howManyMessages){
							      timeSpentInFacebook_bot = "-";
							      startingTime = answer[i].info.startTimeL;
							      timestampFacebook_priv = new Date(startingTime);
							      if(timestampFacebook_priv.getHours() > 21 || timestampFacebook_priv.getHours() < 8){
								     night = "Yes"; 
							      } else{
								      night = "No";
							      }
							      var conversationBorn = 0;
							      var conversationAnswered = 0;
							      var tempoRisposta = 0;
							      if (answer[i].messageRecords[0].sentBy === "Consumer"){
								      conversationBorn = answer[i].messageRecords[0].timeL;
								      conversationAnswered = 0;
								      for (var nbv = 1; nbv < howManyMessages; nbv++){
									      if(answer[i].messageRecords[nbv].sentBy === "Agent" && answer[i].messageRecords[nbv].participantId !== FacebookBotID){
										      tempoRisposta = (answer[i].messageRecords[nbv].timeL - conversationBorn)/1000;
										      conversationAnswered = 1;
										      nbv = howManyMessages;
									      }
								      }
								      
								      if (conversationAnswered){
									      firstTimeAnswer = Math.floor(parseInt(tempoRisposta));
									      firstTimeAnswerFacebook = firstTimeAnswer.toString();
								      }
								      else{
									      firstTimeAnswerFacebook = "NOT_ANSWERED"
								      }
							      }
							      
							      
							      
							      
							      
							      
							      if (answer[i].messageRecords[0].sentBy === "Consumer"){
								      isAnswered = 0;
								      whatTime = answer[i].messageRecords[0].timeL;
								      if(answer[i].hasOwnProperty('agentParticipants') && answer[i].agentParticipants.length){
									      for (var b = 0; b < answer[i].agentParticipants.length; b++){
										      if(answer[i].agentParticipants[b].userTypeName === "Human"){
											      TimeAnswer = (answer[i].agentParticipants[b].timeL - whatTime)/1000;
											      isAnswered = 1;
											      b = answer[i].agentParticipants.length;
										      }
									      }
										
								      }
								      if (isAnswered){
									      timeToAccept = parseInt(TimeAnswer);
									      if(timeToAccept < 0){
										     timeToAccept = 0; 
									      }
									      timeToAcceptFacebook = timeToAccept;
									      timeToAcceptFacebook = timeToAcceptFacebook.toString();
								      }
								      else{
									      timeToAccept = "NOT_ACCEPTED"
									      firstTimeAnswerFacebook = "-";
									      timestampFacebook_priv = "-";      
								      }
							      }
						      }
						      
						      var efforttime = 0;
						      var startTimestamp = 0;
						      var managedByAgent = 0;
						      howManyMessages = answer[i].messageRecords.length;
						      if(howManyMessages && answer[i].hasOwnProperty('agentParticipants') && (answer[i].info.status) === "CLOSE"){
							      var howManyPartecipants = answer[i].agentParticipants.length;
							      if ((howManyPartecipants == 1) && (answer[i].agentParticipants[0].agentLoginName !== "facebookbot") && (answer[i].agentParticipants[0].permission === "ASSIGNED_AGENT") && !((answer[i].agentParticipants[0].agentLoginName).indexOf("@") > -1)){
								      efforttime = ((answer[i].messageRecords[(howManyMessages - 1)].timeL - answer[i].agentParticipants[0].timeL)/1000);
							      }
							      else{
								      for (var z = 0; z < howManyPartecipants; z++){
									      if ((answer[i].agentParticipants[z].agentLoginName !== "facebookbot") && (answer[i].agentParticipants[z].permission === "ASSIGNED_AGENT") && !((answer[i].agentParticipants[z].agentLoginName).indexOf("@") > -1) && !managedByAgent){
										      startTimestamp = answer[i].agentParticipants[z].timeL;
										      managedByAgent = 1;
									      } else if(managedByAgent && (answer[i].agentParticipants[z].agentLoginName === "facebookbot")){
										      efforttime = efforttime + ((answer[i].agentParticipants[z].timeL - startTimestamp)/1000);
										      managedByAgent = 0;
									      }
								      }
								      if(managedByAgent){
									      efforttime = efforttime + ((answer[i].messageRecords[(howManyMessages - 1)].timeL - startTimestamp)/1000);
								      }
							      }
						      }
						      if (efforttime < 0){
							     efforttime = "---"; 
						      }
						      if (efforttime == 0){
							    efforttime = "---";  
						      }
						      else{
							    efforttime = Math.floor(efforttime)  
						      }
						      
						      if(answer[i].hasOwnProperty('agentParticipants')){
							      var arrayPartecipantAgents = [];
							      var arrayPartecipantGroups = [];
							      var howManyPartecipants = answer[i].agentParticipants.length;
							      for (var z = 0; z < howManyPartecipants; z++){
								      if((answer[i].agentParticipants[z].agentLoginName !== "facebookbot") && (answer[i].agentParticipants[z].permission === "ASSIGNED_AGENT") && !((answer[i].agentParticipants[z].agentLoginName).indexOf("@") > -1)){
									      if(!arrayPartecipantAgents.includes(answer[i].agentParticipants[z].agentLoginName)){
										      arrayPartecipantAgents.push(answer[i].agentParticipants[z].agentLoginName);
									      }
									      if(!arrayPartecipantGroups.includes(answer[i].agentParticipants[z].agentGroupName)){
										      arrayPartecipantGroups.push(answer[i].agentParticipants[z].agentGroupName);
									      }
								      }
							      }
							      var numeroagenti = arrayPartecipantAgents.length;
							      var numerogruppi = arrayPartecipantGroups.length;
							      // console.log(arrayPartecipantAgents);
							      // console.log(arrayPartecipantGroups);
						      }
						      
						      var endDateEngagement = "";
						      var durationinseconds = "";
						      var startDateEngagement = new Date(answer[i].info.startTimeL);
						      if (answer[i].info.endTimeL != -1){
							      endDateEngagement = new Date(answer[i].info.endTimeL);
							      durationinseconds = Math.floor((answer[i].info.endTimeL - answer[i].info.startTimeL)/1000);
						      }
						      else{
							      endDateEngagement = "---";
							      durationinseconds = "---";
						      }
						      
						      var lastActivityAgent = 0;
						      var lastTypeActivityAgent = 0;
						      if((lastMessageAgent !== 0) || (lastTagFromAgent !== 0)){
							      if(lastMessageAgent > lastTagFromAgent){
								      lastActivityAgent = new Date(lastMessageAgent);
								      lastTypeActivityAgent = "Message";
							      } else{
								      lastActivityAgent = new Date(lastTagFromAgent);
								      lastTypeActivityAgent = "Tag";
							      }
						      }
						      
						      var inactivetime = durationinseconds - effortTimeGeneral - effortTimeOutbound;
						      
						      
						      
						      var timestampLastActGen = 0;
						      var timestampLastActOut = 0;
						      
						      // if(answer[i].info.conversationId === "0a0c7e37-467b-4de9-bf36-8c2ea0e7c2d3"){
								// console.log("hoooray!!");
						       // }
						      
						      howManyMessages = answer[i].messageRecords.length;
						      if(howManyMessages){
						      		
									var transferLength = answer[i].transfers.length;
									var thisIsGeneral = true;
									var thisIsOutbound = false;
									var startThisPeriod = 0;
									var endThisPeriod = 0;
									var lastMessageSentGeneral = 0;
									var lastMessageSentOutbound = 0;
							      		var lastTagGenFromAgent = 0;
							      		var lastTagOutFromAgent = 0;
							      
							      		startThisPeriod = answer[i].info.startTimeL;
									for (var z = 0; z < transferLength; z++){
										if((answer[i].transfers[z].targetSkillName.indexOf("acebook") > -1) || (answer[i].transfers[z].targetSkillName.indexOf("uman") > -1) || (answer[i].transfers[z].targetSkillName.indexOf("Fixed") > -1)){
											if(!thisIsGeneral){
												thisIsGeneral = true;
												startThisPeriod = answer[i].transfers[z].timeL;
											}
										}
										if(answer[i].transfers[z].targetSkillName.indexOf("utbound") > -1){
											if(thisIsGeneral){
												thisIsGeneral = false;
												endThisPeriod = answer[i].transfers[z].timeL;
												if((lastTagFromAgent > startThisPeriod) && (lastTagFromAgent < endThisPeriod)){
													lastTagGenFromAgent = lastTagFromAgent;
												}
												for (var m = (howManyMessages - 1); m > -1 ; m--){
													if((answer[i].messageRecords[m].timeL < endThisPeriod) && (answer[i].messageRecords[m].timeL > startThisPeriod) && (answer[i].messageRecords[m].sentBy === "Agent") && (answer[i].messageRecords[m].participantId !== "1089636032")){
														lastMessageSentGeneral = answer[i].messageRecords[m].timeL;
														m = 0;
													}
												}
											}
										}
										if(thisIsGeneral){
											if(answer[i].transfers[z].hasOwnProperty('contextData')){
												if(answer[i].transfers[z].contextData.hasOwnProperty('structuredMetadata')){
													if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "telefono"){
														timestampLastActGen = answer[i].transfers[z].timeL;
													}
													if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "awakeLater"){
														timestampLastActGen = answer[i].transfers[z].timeL;
													}
												}
											}
											if((transferLength - z) === 1){
												endThisPeriod = Date.now();
												for (var m = (howManyMessages - 1); m > -1 ; m--){
													if((answer[i].messageRecords[m].timeL < endThisPeriod) && (answer[i].messageRecords[m].timeL > startThisPeriod) && (answer[i].messageRecords[m].sentBy === "Agent") && (answer[i].messageRecords[m].participantId !== "1089636032")){
														lastMessageSentGeneral = answer[i].messageRecords[m].timeL;
														m = 0;
													}
												}
											}
										}
										
										
									}
									if(lastMessageSentGeneral > timestampLastActGen){
										timestampLastActGen = lastMessageSentGeneral;
									}
							      		if(lastTagGenFromAgent > timestampLastActGen){
										timestampLastActGen = lastTagGenFromAgent;
										lastTypeActivityAgent = "Tag";
									}
							      
									
									thisIsGeneral = false;
									thisIsOutbound = false;
									
									for (var z = 0; z < transferLength; z++){
										if(answer[i].transfers[z].targetSkillName.indexOf("utbound") > -1){
											if(!thisIsOutbound){
												thisIsOutbound = true;
												startThisPeriod = answer[i].transfers[z].timeL;
											}
										}
										if((answer[i].transfers[z].targetSkillName.indexOf("acebook") > -1) || (answer[i].transfers[z].targetSkillName.indexOf("uman") > -1) || (answer[i].transfers[z].targetSkillName.indexOf("Fixed") > -1)){
											if(thisIsOutbound){
												thisIsOutbound = false;
												endThisPeriod = answer[i].transfers[z].timeL;
												if((lastTagFromAgent > startThisPeriod) && (lastTagFromAgent < endThisPeriod)){
													lastTagOutFromAgent = lastTagFromAgent;
												}
												for (var m = (howManyMessages - 1); m > -1 ; m--){
													if((answer[i].messageRecords[m].timeL < endThisPeriod) && (answer[i].messageRecords[m].timeL > startThisPeriod) && (answer[i].messageRecords[m].sentBy === "Agent") && (answer[i].messageRecords[m].participantId !== "1089636032")){
														lastMessageSentOutbound = answer[i].messageRecords[m].timeL;
														m = 0;
													}
												}
											}
										}
										if(thisIsOutbound){
											if(answer[i].transfers[z].hasOwnProperty('contextData')){
												if(answer[i].transfers[z].contextData.hasOwnProperty('structuredMetadata')){
													if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "telefono"){
														timestampLastActOut = answer[i].transfers[z].timeL;
													}
													if(answer[i].transfers[z].contextData.structuredMetadata[0].botResponse.intents[0].id === "awakeLater"){
														timestampLastActOut = answer[i].transfers[z].timeL;
													}
												}
											}
											if((transferLength - z) === 1){
												endThisPeriod = Date.now();
												for (var m = (howManyMessages - 1); m > -1 ; m--){
													if((answer[i].messageRecords[m].timeL < endThisPeriod) && (answer[i].messageRecords[m].timeL > startThisPeriod) && (answer[i].messageRecords[m].sentBy === "Agent") && (answer[i].messageRecords[m].participantId !== "1089636032")){
														lastMessageSentOutbound = answer[i].messageRecords[m].timeL;
														m = 0;
													}
												}
											}
										}
										
									}
									if(lastMessageSentOutbound > timestampLastActOut){
										timestampLastActOut = lastMessageSentOutbound;
									}
							      		if(lastTagOutFromAgent > timestampLastActGen){
										timestampLastActGen = lastTagOutFromAgent;
										lastTypeActivityAgent = "Tag";
									}
									
								
						      		
							      
						      }
						      
						      if(timestampLastActGen === 0){
						      		timestampLastActGen = "-";
						      } else{
						      		timestampLastActGen = new Date(timestampLastActGen);
						      }
						      
						      if(timestampLastActOut === 0){
						      		timestampLastActOut = "-";
						      } else{
						      		timestampLastActOut = new Date(timestampLastActOut);
						      }
						      
						      
						      
						      var timestampNextUnfreeze = "-";
						      if (answer[i].hasOwnProperty('transfers')){
						      		var transferlength = answer[i].transfers.length;
								if (transferlength > 1){
									if(answer[i].transfers[(transferlength - 2)].hasOwnProperty('contextData')){
										if(answer[i].transfers[(transferlength - 2)].contextData.hasOwnProperty('structuredMetadata')){
											if(answer[i].transfers[(transferlength - 2)].contextData.structuredMetadata[0].botResponse.intents[0].id === "awakeLater"){
												timestampNextUnfreeze = new Date(parseInt(answer[i].transfers[(transferlength - 2)].contextData.structuredMetadata[0].botResponse.intents[0].name));
											}
										}
									}
								}
						      }
						      
						      
						      var campo3 = "";
				
				/*************** fix per Microsoft ***************/
				
				if(answer[i].info.conversationId === "b4372dc7-cbac-4b45-b819-5a3a6c3fbd46"){
					console.log("oi");
				}
				
				var match = /\r|\n/.exec(imeiNumber);
					
					if(match){
						imeiNumber = "invalid format";
					}
				
				match = /\r|\n/.exec(phoneNumber);
				
				if(match){
						phoneNumber = "invalid format";
					}
				
				
	
						     
						      
						      var pieceToAdd = [startDateEngagement,
									endDateEngagement,
									durationinseconds,
									effortTimeGeneral,
									effortTimeOutbound,
									inactivetime,
									lastAgentGeneral,
									lastAgentOutbound,
									lastProperTeamGeneral,
									lastProperTeamOutbound,
									skill,
									channel,
									night,
									facebook_out,
									numero_telefono,
									numero_ricontatto,
									numero_cfiscale,
									vfTag,
									triplettauno,
									triplettadue,
									triplettatre,
									limbo,
									limboGeneral,
									limboOutbound,
									limboaveragetime,
									risvegliata,
									risvegliataGeneral,
									risvegliataOutbound,
									freeze,
									freezeGeneral,
									freezeOutbound,
									risvegliataFreeze,
									risvegliataFreezeGeneral,
									risvegliataFreezeOutbound,
									numberAgentsGeneral,
									numberAgentsOutbound,
									numberTeamsGeneral,
									numberTeamsOutbound,
									yesno,
									comments,
									endReason,
									timeToAcceptFacebook,
									firstTimeAnswerFacebook,
									timestampFacebook_priv,
									timestampOutbound,
									timeSpentInFacebook_bot,
									timestampLastActGen,
									timestampLastActOut,
									timestampNextUnfreeze,
									lastActivityAgent,
									lastTypeActivityAgent,
									customerName,
									phoneNumber,
									imeiNumber,
									answer[i].info.conversationId,
									messages,
									campo1,
									campo2,
									campo3
								       ];
				
						
				
									
								var pieceToAddLength = pieceToAdd.length;
								for(var pta = 0; pta < pieceToAddLength; pta++){
									myFileToXLS += pieceToAdd[pta];
									myFileToXLS += "\t";
								}
								myFileToXLS += "\n";
				if (proceed === true){
					if (i == (totalLength - 1)){
						exportData();
					}
				}
			}, 0, i);
		}
		
	}
	
	
	
	
 
 
 
 function downloadTranscripts(start, end, options){
	 
	 testTypes = {
    			"start": "String",
    			"end": "String",
			"durationinseconds": "String",
			"efforttimegeneral": "String",
			"efforttimeoutbound": "String",
			"inactivetime": "String",
    			"agentgeneral": "String",
			"agentoutbound": "String",
			"teamgeneral": "String",
			"teamoutbound": "String",
			"skill": "String",
			"channel": "String",
			"night": "String",
			"outbound": "String",
			"telefono": "String",
			"ricontatto": "String",
			"cfiscale": "String",
			"tags": "String",
			"triplettauno": "String",
			"triplettadue": "String",
			"triplettatre": "String",
			"limbo": "String",
			"limboGeneral": "String",
			"limboOutbound": "String",
			"limboaveragetime": "String",
			"risvegliata": "String",
			"risvegliataGeneral": "String",
			"risvegliataOutbound": "String",
			"freeze": "String",
			"freezeGeneral": "String",
			"freezeOutbound": "String",
			"risvFreeze": "String",
			"risvFreezeGeneral": "String",
			"risvFreezeOutbound": "String",
			"numeroagentigeneral": "String",
			"numeroagentioutbound": "String",
			"numerogruppigeneral": "String",
			"numerogruppioutbound": "String",
			"yesno": "String",
			"comments": "String",
			"endReason": "String",
			"timeToAccept": "String",
			"firstTimeAnswer": "String",
			"timestampFacebook_priv": "String",
			"timestampOutbound": "String",
			"timeInFacebook_bot": "String",
			"timestampLastActGen": "String",
			"timestampLastActOut": "String",
			"timestampNextUnfreeze": "String",
			"lastActivityAgent": "String",
			"lastTypeActivityAgent": "String",
			"customerName": "String",
			"phoneNumber": "String",
			"imeiNumber": "String",
    			"conversation": "String",
    			"transcript": "String",
			"campo1": "String",
			"campo2": "String",
			"campo3": "String"
		 };
	 
	 var conversationsToDownload = 0;
	 var conversationsPartial = 0;
	 var offset = 0;
	 var body = "";
	 var answer = [];
	 exportObject = [];
	 
	 $("#downloadTranscripts").prop( "disabled", true ); 
	 
	 if (options === "Open"){ 
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["OPEN"]}'; 
	 }
	 else if (options === "Close"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["CLOSE"]}';	 
	 }
	 else if (options === "Open+Close"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '}, "status":["OPEN","CLOSE"]}';	 
	 }
	 
	 myFileToXLS = "";
	 for (var colName in testTypes) {
        	myFileToXLS += colName;
		myFileToXLS += "\t";      
    	 }
	 myFileToXLS += "\n";
	 
	 function tryUntilSuccess(offset, callback) {
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      
				      if(offset == 0){
					      conversationsToDownload = data._metadata.count;
					      if (conversationsToDownload === 0){
						      document.getElementById("reportMSG").innerHTML = "I've not found any conversation in this period!";
						      document.getElementById("reportMSG").style = "color : red";
						      $("#downloadTranscripts").prop( "disabled", false ); 
					      }
				      }
				      if (conversationsToDownload > 0){
					      conversationsPartial = conversationsPartial + data.conversationHistoryRecords.length;
					      if(conversationsPartial < conversationsToDownload){
							      offset = conversationsPartial;
							      answer = data.conversationHistoryRecords;
							      document.getElementById("reportMSG").innerHTML = "...downloading sessions:" + Math.round(100*(offset/data._metadata.count)) + "% completed...";
							      document.getElementById("reportMSG").style = "color : green";      
							      // console.log(data.conversationHistoryRecords);
							      console.log ("adding conversations...");
							      console.log(offset + " of --> " + conversationsToDownload);
							      analysis(answer, false);
							      tryUntilSuccess(offset, callback);
					      }
					      else{
						      console.log("last bucket: " + data.conversationHistoryRecords.length);
						      answer = data.conversationHistoryRecords;
						      document.getElementById("reportMSG").innerHTML = conversationsPartial + " Messaging conversations downloaded with success!";
						      document.getElementById("reportMSG").style = "color : green";
						      analysis(answer, true);
						      
					      }
				      }
				      
				      
     
				      
                              },
                              error: function error(e, text) {
				      document.getElementById("reportMSG").innerHTML = "System error. Please try again!";
				      document.getElementById("reportMSG").style = "color : red";  
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 
	 tryUntilSuccess(offset, function(err, resp) {
		 // Your code here...
	 });
	 
	 
	 
	 console.log(start + "****" + end + "****" + options);
	 
 }
   
    
</script>
    
    


</body>
</html>
